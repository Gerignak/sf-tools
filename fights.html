<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Exporter</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>

        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/components/state.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>

        <script src="js/playa.js"></script>

        <script src="js/core.js"></script>
        <script src="js/event.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="ui fixed borderless huge menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i>Go back</a>
            </div>
        </div>
        <div class="ui main container">
            <div class="ui middle aligned margin-medium-bottom grid">
                <div class="three wide column">
                    <label class="ui fluid button" for="fi-open">
                        <i class="small upload icon"></i> Open file
                    </label>
                    <input type="file" id="fi-open" hidden>
                </div>
                <div class="three wide column">

                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Fight Exporter</h1>
                </div>
                <div class="six wide column">

                </div>
            </div>
            <div class="ui form" id="fi-results" hidden>
                <div class="ui grid">
                    <div class="two columns row">
                        <div class="column">
                            <div class="ui grid">
                                <div class="eight wide column">
                                    <h2 class="ui centered header" id="fi-a-name"></h2>
                                </div>
                                <div class="two wide column">
                                    <h2 class="ui centered header" id="fi-a-level"></h2>
                                </div>
                                <div class="six wide column">
                                    <h2 class="ui centered header" id="fi-a-class"></h2>
                                </div>
                                <div class="sixteen wide column">
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Minimum damage</label>
                                            <input type="text" id="fi-a-min">
                                        </div>
                                        <div class="field">
                                            <label>Maximum damage</label>
                                            <input type="text" id="fi-a-max">
                                        </div>
                                    </div>
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Strength</label>
                                            <input type="text" id="fi-a-strength">
                                        </div>
                                        <div class="field">
                                            <label>Constitution</label>
                                            <input type="text" id="fi-a-constitution">
                                        </div>
                                    </div>
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Dexterity</label>
                                            <input type="text" id="fi-a-dexterity">
                                        </div>
                                        <div class="field">
                                            <label>Luck</label>
                                            <input type="text" id="fi-a-luck">
                                        </div>
                                    </div>
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Intelligence</label>
                                            <input type="text" id="fi-a-intelligence">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="ui grid">
                                <div class="eight wide column">
                                    <h2 class="ui centered header" id="fi-b-name"></h2>
                                </div>
                                <div class="two wide column">
                                    <h2 class="ui centered header" id="fi-b-level"></h2>
                                </div>
                                <div class="six wide column">
                                    <h2 class="ui centered header" id="fi-b-class"></h2>
                                </div>
                                <div class="sixteen wide column">
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Minimum damage</label>
                                            <input type="text" id="fi-b-min">
                                        </div>
                                        <div class="field">
                                            <label>Maximum damage</label>
                                            <input type="text" id="fi-b-max">
                                        </div>
                                    </div>
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Strength</label>
                                            <input type="text" id="fi-b-strength">
                                        </div>
                                        <div class="field">
                                            <label>Constitution</label>
                                            <input type="text" id="fi-b-constitution">
                                        </div>
                                    </div>
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Dexterity</label>
                                            <input type="text" id="fi-b-dexterity">
                                        </div>
                                        <div class="field">
                                            <label>Luck</label>
                                            <input type="text" id="fi-b-luck">
                                        </div>
                                    </div>
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Intelligence</label>
                                            <input type="text" id="fi-b-intelligence">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="column" id="fi-attacks">

                        </div>
                    </div>
                </div>
            </div>
            <div class="ui form margin-medium-top">
                <div class="field">
                    <textarea id="fi-output"></textarea>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            (function ($) {
                $('#fi-output').val('');
                $('#fi-open').on('change', function () {
                    var reader = new FileReader();
                    reader.readAsText(this.files[0], 'UTF-8');
                    reader.onload = event => {
                        try {
                            var json = JSON.parse(event.target.result);
                            var raws = [];
                            for (var [key, val, url] of filterPlayaJSON(json)) {
                                if (key === 'text' && val.includes('fightheader')) {
                                    raws.push(val);
                                }
                            }

                            var messages = { };
                            for (var raw of raws) {
                                for (var [key, val] of parsePlayaResponse(raw)) {
                                    if (key.includes('fight') || key.includes('winnerid')) {
                                        var k = key.split('.');
                                        messages[k.length > 1 ? k[k.length - 1] : k[0]] = val.replace(/,/g, '/').split('/');
                                    }
                                }
                            }

                            if (!messages['fighters'] || messages['fighters'][0] != 0 || !messages['winnerid'] || !messages['r']) {
                                throw 'Invalid fight type!';
                            } else {
                                var fighters = messages['fighters'].slice(5);
                                var [fa, fb] = [fighters.slice(0, 47), fighters.slice(47, 94)].map(data => {
                                    var f = { };
                                    var x = data.map(d => isNaN(d) ? d : Number(d));

                                    f.id = x[0];
                                    f.name = x[1];
                                    f.level = x[2];
                                    f.health = x[3];
                                    f.strength = x[5];
                                    f.dexterity = x[6];
                                    f.intelligence = x[7];
                                    f.constitution = x[8];
                                    f.luck = x[9];

                                    f.race = x[20];
                                    f.gender = x[21];
                                    f.class = PLAYER_CLASS[x[22]];

                                    f.damagemin = x[25];
                                    f.damagemax = x[26];

                                    return f;
                                });

                                fighters = [fa, fb];

                                $('#fi-a-name').text(fa.name);
                                $('#fi-a-level').text(fa.level);
                                $('#fi-a-class').text(fa.class);
                                $('#fi-a-min').val(fa.damagemin);
                                $('#fi-a-max').val(fa.damagemax);
                                $('#fi-a-strength').val(fa.strength);
                                $('#fi-a-dexterity').val(fa.dexterity);
                                $('#fi-a-intelligence').val(fa.intelligence);
                                $('#fi-a-constitution').val(fa.constitution);
                                $('#fi-a-luck').val(fa.luck);

                                $('#fi-b-name').text(fb.name);
                                $('#fi-b-level').text(fb.level);
                                $('#fi-b-class').text(fb.class);
                                $('#fi-b-min').val(fb.damagemin);
                                $('#fi-b-max').val(fb.damagemax);
                                $('#fi-b-strength').val(fb.strength);
                                $('#fi-b-dexterity').val(fb.dexterity);
                                $('#fi-b-intelligence').val(fb.intelligence);
                                $('#fi-b-constitution').val(fb.constitution);
                                $('#fi-b-luck').val(fb.luck);

                                var winner = messages['winnerid'][0] == fa.id ? fa : fb;

                                var rounds = [ ];
                                for (var i = 0; i < messages['r'].length / 3; i++) {
                                    var attack = messages['r'].slice(i * 3, i * 3 + 3);
                                    rounds.push({
                                        id: attack[0],
                                        type: {
                                            0: 'Normal',
                                            1: 'Critical',
                                            2: 'Catapult',
                                            3: 'Blocked',
                                            4: 'Evaded',
                                            5: 'NormalSecondary',
                                            6: 'CriticalSecondary',
                                            7: 'BlockedSecondary',
                                            8: 'EvadedSecondary',
                                            15: 'Fireball',
                                            16: 'FireballBlock',
                                            20: 'BerserkerNormal',
                                            21: 'BerserkerCritical',
                                            23: 'BerserkerBlocked',
                                            24: 'BerserkerEvaded'
                                        }[attack[1]],
                                        health: attack[2],
                                        crit: attack[1] == 1 || attack[1] == 6 || attack[1] == 21
                                    });
                                }

                                rounds.forEach((round, i) => {
                                    if (round.id == fa.id) {
                                        round.source = fa;
                                        round.target = fb;
                                    } else {
                                        round.source = fb;
                                        round.target = fa;
                                    }

                                    round.damage = (function (rs, inx, src, tar) {
                                        for (var l = inx - 1; l >= 0; l--) {
                                            if (rs[l].id == src.id) return rs[l].health;
                                        }
                                        return tar.health;
                                    })(rounds, i, round.source, round.target) - round.health;
                                });

                                $('#fi-output').val(`Player1:\n${ Object.entries(fa).map(kv => `${ kv[0] }: ${ kv[1] }`).join('\n') }\n\nPlayer2:\n${ Object.entries(fb).map(kv => `${ kv[0] }: ${ kv[1] }`).join('\n') }\n\nWinner: ${ winner.name }\n\nRounds:\n${ rounds.map((r, fi) => `${ fi }: ${ r.source.name } (${ r.type }): ${ r.damage }`).join('\n') }`);

                                $('#fi-attacks').html('');
                                rounds.forEach((round, i) => {
                                    $('#fi-attacks').append(`
                                        <div class="ui segment">
                                            <div class="ui grid">
                                                <div class="one wide column">${ i + 1 }</div>
                                                <div class="two wide column"><b>${ round.source.name }</b></div>
                                                <div class="one wide column">></div>
                                                <div class="two wide column"><b>${ round.target.name }</b></div>
                                                <div class="two wide column"></div>
                                                <div class="two wide column text-center ${ round.crit ? 'foreground-red' : '' }">${ round.type }</div>
                                                <div class="four wide column text-center ${ round.crit ? 'foreground-red' : '' }">${ round.damage }</div>
                                                <div class="two wide column"></div>
                                            </div>
                                        </div>
                                    `);
                                });

                                $('#fi-results').show();
                            }
                        } catch (e) {
                            $('#fi-output').val(e);
                        }
                    };
                });
            })(jQuery);
        </script>
    </body>
</html>
