<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Viewer</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>

        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/components/state.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="ui fixed borderless huge menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i>Go back</a>
            </div>
        </div>
        <div class="ui main container">
            <div class="ui middle aligned margin-medium-bottom grid">
                <div class="two wide column">
                    <label class="ui fluid button" for="fi-open">
                        <i class="upload icon"></i> Open
                    </label>
                    <input type="file" id="fi-open" multiple hidden>
                </div>
                <div class="two wide column">
                    <a class="ui fluid button" id="fi-clear"><i class="trash alternate outline icon"></i>Clear</a>
                </div>
                <div class="two wide column text-center">
                    <div class="ui icon buttons">
                        <button class="ui button" id="fi-copyall">
                            <i class="copy outline icon"></i>
                        </button>
                        <button class="ui button" id="fi-saveall">
                            <i class="save outline icon"></i>
                        </button>
                    </div>
                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Fight Viewer</h1>
                </div>
                <div class="four wide column">
                    <div class="ui form field">
                        <div class="ui selection fluid dropdown" style="height: 3.5em !important; margin-left: -2em !important; width: 22em !important;">
                            <input type="hidden" id="fi-select">
                            <i class="dropdown icon"></i>
                            <div class="default text"></div>
                            <div class="menu" id="fi-select-items">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="two wide column text-center">
                    <div class="ui icon buttons">
                        <button class="ui button" id="fi-copy">
                            <i class="copy outline icon"></i>
                        </button>
                        <button class="ui button" id="fi-save">
                            <i class="save outline icon"></i>
                        </button>
                    </div>
                </div>
            </div>
            <h3 class="ui centered header red" id="fi-error" hidden></h3>
            <div id="fi-content">
                    <div class="ui secondary grid" id="fi-select">

                    </div>
                <div id="fi-content-pages">

                </div>
            </div>
        </div>

        <script type="text/javascript">
            (function ($) {
                $('#fi-select').on('change', function () {
                    $('[data-tab]').removeClass('active');
                    $(`[data-tab="${ $(this).val() }"]`).addClass('active');
                });
                $('#fi-select').val('');
                $('#fi-copy').on('click', function () {
                    if ($('[data-tab]').length == 0) return;
                    var el = document.createElement('textarea');
                    var tab = tabs[$('[data-tab].active').attr('data-tab')];
                    el.value = `name:\t${tab.name}\nfightera:\n${ Object.entries(tab.fa).map(kv => `${ kv[0] }\t${ kv[1] }`).join('\n') }\nfighterB:\n${ Object.entries(tab.fb).map(kv => `${ kv[0] }\t${ kv[1] }`).join('\n') }\nrounds:\n${ tab.rounds.map((r, i) => `${i}\t${r.src.id}\t${r.tar.id}\t${r.atype}\t${r.damage}`).join('\n') }`;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                });

                var tabs = [];
                var tabsadded = false;

                // Remove all tabs
                function clearTabs() {
                    tabs = [];
                }

                // Add new tab
                function addTab(... tab) {
                    tabs.push(... tab);
                }

                // Update document
                function updateTabs() {
                    if (tabs.length) {
                        $('#fi-content').show();
                        $('#fi-select-items').html(tabs.map((tab, index) => `<div class="item${ !tabsadded && index == 0 ? ' active selected' : '' }" data-value="${ index }"><div class="fi-wrap"><div class="fi-left">${ index + 1 }.</div><div class="fi-right">${ tab.fa.name }</br>${ tab.fb.name }</div></div></div>`).join(''));
                        $('#fi-content-pages').html(tabs.map((tab, index) => `
                            <div class="ui tab basic segment${ !tabsadded && index == 0 ? ' active' : '' }${ index == 0 ? ' margin-medium-top' : '' }" data-tab="${ index }">
                                <div class="ui small form">
                                    <div class="ui grid">
                                        <div class="two columns row">
                                            <div class="column">
                                                <h2 class="ui centered header">${ tab.fa.name }</h2>
                                                <div class="two fields">
                                                    <div class="field">
                                                        <label>Class</label>
                                                        <input type="text" value="${ tab.fa.class }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Level</label>
                                                        <input type="text" value="${ tab.fa.level }" disabled class="text-center">
                                                    </div>
                                                </div>
                                                <div class="two fields">
                                                    <div class="field">
                                                        <label>Minimum damage</label>
                                                        <input type="text" value="${ tab.fa.damagemin || '' }${ tab.fa.damagemin2 ? ` (${ tab.fa.damagemin2 })` : '' }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Maximum damage</label>
                                                        <input type="text" value="${ tab.fa.damagemax || '' }${ tab.fa.damagemax2 ? ` (${ tab.fa.damagemax2 })` : '' }" disabled class="text-center">
                                                    </div>
                                                </div>
                                                <div class="five fields">
                                                    <div class="field">
                                                        <label>Strength</label>
                                                        <input type="text" value="${ tab.fa.strength }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Constitution</label>
                                                        <input type="text" value="${ tab.fa.constitution }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Dexterity</label>
                                                        <input type="text" value="${ tab.fa.dexterity }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Luck</label>
                                                        <input type="text" value="${ tab.fa.luck }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Intelligence</label>
                                                        <input type="text" value="${ tab.fa.intelligence }" disabled class="text-center">
                                                    </div>
                                                </div>
                                                <div class="two fields">
                                                    <div class="field">
                                                        <label>Health</label>
                                                        <input type="text" value="${ formatAsSpacedNumber(tab.fa.maxhealth) }" disabled class="text-center">
                                                    </div>
                                                    ${ tab.fa.health != tab.fa.maxhealth ? `
                                                        <div class="field">
                                                            <label>Current Health</label>
                                                            <input type="text" value="${ formatAsSpacedNumber(tab.fa.health) }" disabled class="text-center">
                                                        </div>
                                                    ` : '' }
                                                </div>
                                            </div>
                                            <div class="column">
                                                <h2 class="ui centered header">${ tab.fb.name }</h2>
                                                <div class="two fields">
                                                    <div class="field">
                                                        <label>Class</label>
                                                        <input type="text" value="${ tab.fb.class }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Level</label>
                                                        <input type="text" value="${ tab.fb.level }" disabled class="text-center">
                                                    </div>
                                                </div>
                                                <div class="two fields">
                                                    <div class="field">
                                                        <label>Minimum damage</label>
                                                        <input type="text" value="${ tab.fb.damagemin || '' }${ tab.fb.damagemin2 ? ` (${ tab.fb.damagemin2 })` : '' }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Maximum damage</label>
                                                        <input type="text" value="${ tab.fb.damagemax || '' }${ tab.fb.damagemax2 ? ` (${ tab.fb.damagemax2 })` : '' }" disabled class="text-center">
                                                    </div>
                                                </div>
                                                <div class="five  fields">
                                                    <div class="field">
                                                        <label>Strength</label>
                                                        <input type="text" value="${ tab.fb.strength }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Constitution</label>
                                                        <input type="text" value="${ tab.fb.constitution }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Dexterity</label>
                                                        <input type="text" value="${ tab.fb.dexterity }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Luck</label>
                                                        <input type="text" value="${ tab.fb.luck }" disabled class="text-center">
                                                    </div>
                                                    <div class="field">
                                                        <label>Intelligence</label>
                                                        <input type="text" value="${ tab.fb.intelligence }" disabled class="text-center">
                                                    </div>
                                                </div>
                                                <div class="two fields">
                                                    <div class="field">
                                                        <label>Health</label>
                                                        <input type="text" value="${ formatAsSpacedNumber(tab.fb.maxhealth) }" disabled class="text-center">
                                                    </div>
                                                    ${ tab.fb.health != tab.fb.maxhealth ? `
                                                        <div class="field">
                                                            <label>Current Health</label>
                                                            <input type="text" value="${ formatAsSpacedNumber(tab.fb.health) }" disabled class="text-center">
                                                        </div>
                                                    ` : '' }
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="column">
                                                ${ tab.rounds.map((round, i) => `
                                                        <div class="ui basic segment ${ i % 2 ? 'undertone' : '' }">
                                                            <div class="ui grid">
                                                                <div class="one wide column"></div>
                                                                <div class="one wide column">${ i + 1 }</div>
                                                                <div class="three wide column text-right"><b>${ round.src.name }</b></div>
                                                                <div class="one wide column text-center">></div>
                                                                <div class="three wide column"><b>${ round.tar.name }</b></div>
                                                                <div class="one wide column"></div>
                                                                <div class="two wide column text-center ${ round.crit ? 'foreground-red' : '' }">${ ATTACK_TYPES[round.atype] }</div>
                                                                <div class="three wide column text-right ${ round.crit ? 'foreground-red text-bold' : '' }">${ round.damage ? formatAsSpacedNumber(round.damage) : '' }</div>
                                                                <div class="one wide column"></div>
                                                            </div>
                                                        </div>
                                                    `).join('')
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join(''));
                        if (!tabsadded) {
                            $('#fi-select').val('0');
                        } else {
                            $('#fi-select').trigger('change');
                        }
                        tabsadded = true;
                    } else {
                        $('.dropdown').dropdown();
                        $('#fi-content').hide();
                        $('#fi-select-items').html('');
                        $('#fi-content-pages').html('');
                        $('#fi-select').parent('.dropdown').children('.text').text('');
                        tabsadded = false;
                    }

                    $('.dropdown').dropdown();
                }

                // Clear error
                function clearError() {
                    $('#fi-error').hide();
                    $('#fi-error').text('');
                }

                // Show error
                function showError(msg) {
                    $('#fi-error').show();
                    $('#fi-error').text(msg);
                }

                // Parse file
                function parseTabs(json) {
                    var fights = [];
                    var raws = [];

                    for (var [k, v] of filterPlayaJSON(json)) {
                        if (k == 'text' && v.includes('fightheader')) {
                            var cr = [];
                            for (var [kb, vb] of parsePlayaResponse(v)) {
                                if (kb.includes('.fighters')) {
                                    cr.push(['fighters', vb].join(':'));
                                } else if (kb.includes('.r')) {
                                    cr.push(['r', vb].join(':'));
                                } else if (kb.includes('winnerid')) {
                                    cr.push(['winnerid', vb].join(':'));
                                    raws.push(cr.join('&'));
                                    cr = [];
                                }
                            }
                        }
                    }

                    for (var raw of raws) {
                        var msg = {};
                        for (var [k, v] of parsePlayaResponse(raw)) {
                            msg[k] = v.split(/[/,]/g).map(d => isNaN(d) ? d : Number(d));
                        }

                        if (msg['fighters'] && msg['winnerid'] && msg['r'] && Object.values(FIGHT_TYPES).includes(msg['fighters'][0])) {
                            var ftype = msg['fighters'][0];
                            var fighters, [fa, fb] = fighters = [msg['fighters'].slice(5, 52), msg['fighters'].slice(52, 99)].map(x => {
                                return {
                                    id: x[0],
                                    name: getFightTargetName(ftype, x[10] < 0 ? Math.abs(x[10]) : x[1], Math.abs(x[10])),
                                    level: x[2],
                                    maxhealth: x[3],
                                    health: x[4],
                                    strength: x[5],
                                    dexterity: x[6],
                                    intelligence: x[7],
                                    constitution: x[8],
                                    luck: x[9],
                                    face: x[10],
                                    class: PLAYER_CLASS[x[22]],
                                    damagemin: x[25],
                                    damagemax: x[26],
                                    damagemin2: x[22] == 4 ? x[37] : 0,
                                    damagemax2: x[22] == 4 ? x[38] : 0
                                }
                            });
                            var winner = msg['winnerid'][0] == fa.id ? fa : fb;
                            var rounds = [];
                            for (var i = 0; i < msg['r'].length / 3; i++) {
                                var [id, atype, healthleft] = msg['r'].slice(i * 3, i * 3 + 3);
                                rounds.push({
                                    src: id == fa.id ? fa : fb,
                                    tar: id == fa.id ? fb : fa,
                                    atype: atype,
                                    crit: atype % 10 == 1,
                                    healthleft: healthleft
                                });
                            }

                            for (var i = 0, r; r = rounds[i]; i++) {
                                r.damage = (function (_rounds, _i, source, target) {
                                    for (var j = _i - 1; j >= 0; j--) {
                                        if (_rounds[j].src.id == source.id) {
                                            return _rounds[j].healthleft;
                                        }
                                    }

                                    return target.health;
                                })(rounds, i, r.src, r.tar) - r.healthleft;
                            }

                            fights.push({
                                name: `${ fa.name } / ${ fb.name }`,
                                fa: fa,
                                fb: fb,
                                rounds: rounds,
                                winner: winner.id
                            });
                        }
                    }

                    return fights;
                }

                // Event handlers
                $('#fi-open').on('change', function () {
                    Array.from(this.files).forEach(file => {
                        var r = new FileReader();
                        r.readAsText(file, 'UTF-8');
                        r.onload = event => {
                            try {
                                clearError();
                                addTab(... parseTabs(JSON.parse(event.target.result)));
                                updateTabs();
                            } catch (exception) {
                                showError(exception);
                            }
                        };
                    });
                });

                $('#fi-clear').on('click', function () {
                    clearTabs();
                    updateTabs();
                });
            })(jQuery);
        </script>
    </body>
</html>
