<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Viewer</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>

        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/components/state.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="ui fixed borderless huge menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i>Go back</a>
            </div>
        </div>
        <div class="ui main container">
            <div class="ui middle aligned margin-medium-bottom grid">
                <div class="three wide column">
                    <label class="ui fluid button" for="fi-open">
                        <i class="small upload icon"></i> Open file
                    </label>
                    <input type="file" id="fi-open" hidden>
                </div>
                <div class="three wide column">

                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Fight Viewer</h1>
                </div>
                <div class="six wide column">

                </div>
            </div>
            <div id="fi-content">
                <div class="ui secondary menu" id="fi-select">

                </div>
                <div id="fi-content-pages">

                </div>
            </div>
            <h3 class="ui centered header red" id="fi-error" hidden></h3>
        </div>

        <script type="text/javascript">
            (function ($) {
                $('#fi-open').on('change', function () {
                    $('#fi-content').hide();
                    $('#fi-content-pages').html('');
                    $('#fi-select').html('');

                    $('#fi-error').hide();
                    $('#fi-error').text('');

                    var reader = new FileReader();
                    reader.readAsText(this.files[0], 'UTF-8');
                    reader.onload = event => {
                        try {
                            var json = JSON.parse(event.target.result);
                            var raws = [];
                            for (var [key, val, url] of filterPlayaJSON(json)) {
                                if (key === 'text' && val.includes('fightheader')) {
                                    raws.push(val);
                                }
                            }

                            for (var index = 0, raw; raw = raws[index]; index++) {
                                var messages = { };
                                for (var [key, val] of parsePlayaResponse(raw)) {
                                    if (key.includes('fight') || key.includes('winnerid')) {
                                        var k = key.split('.');
                                        messages[k.length > 1 ? k[k.length - 1] : k[0]] = val.replace(/,/g, '/').split('/');
                                    }
                                }

                                if (messages['fighters'] && messages['fighters'][0] == 0 && messages['winnerid'] && messages['r']) {
                                    var fighters = [messages['fighters'].slice(5, 52), messages['fighters'].slice(52, 99)].map(data => {
                                        var x = data.map(d => isNaN(d) ? d : Number(d));
                                        return {
                                            id: x[0],
                                            name: x[1],
                                            level: x[2],
                                            health: x[3],
                                            strength: x[5],
                                            dexterity: x[6],
                                            intelligence: x[7],
                                            constitution: x[8],
                                            luck: x[9],
                                            class: PLAYER_CLASS[x[22]],
                                            damagemin: x[25],
                                            damagemax: x[26]
                                        };
                                    });
                                    var [a, b] = fighters;
                                    var winner = messages['winnerid'][0] == a.id ? a : b;

                                    var rounds = [ ];
                                    for (var i = 0; i < messages['r'].length / 3; i++) {
                                        var [id, type, hpleft] = messages['r'].slice(i * 3, i * 3 + 3);
                                        rounds.push({
                                            source: id == a.id ? a : b,
                                            target: id == a.id ? b : a,
                                            type: ATTACK_TYPES[type],
                                            crit: type == 1 || type == 6 || type == 21,
                                            health: hpleft
                                        });
                                    }

                                    rounds.forEach((round, i) => {
                                        round.damage = (function (rs, inx, src, tar) {
                                            for (var l = inx - 1; l >= 0; l--) {
                                                if (rs[l].source.id == src.id) return rs[l].health;
                                            }
                                            return tar.health;
                                        })(rounds, i, round.source, round.target) - round.health;
                                    });

                                    $('#fi-select').append(`<a class="item ${ index ? '' : 'active' }" data-tab="tab${ index }">${ a.name } / ${ b.name }</a>`)
                                    $('#fi-content-pages').append(`
                                        <div class="ui tab basic segment ${ index ? '' : 'active' }" data-tab="tab${ index }">
                                            <div class="ui small form">
                                                <div class="ui grid">
                                                    <div class="two columns row">
                                                        <div class="column">
                                                            <h2 class="ui centered header">${ a.name }</h2>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Class</label>
                                                                    <input type="text" value="${ a.class }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Level</label>
                                                                    <input type="text" value="${ a.level }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Minimum damage</label>
                                                                    <input type="text" value="${ a.damagemin }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Maximum damage</label>
                                                                    <input type="text" value="${ a.damagemax }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Strength</label>
                                                                    <input type="text" value="${ a.strength }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Constitution</label>
                                                                    <input type="text" value="${ a.constitution }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Dexterity</label>
                                                                    <input type="text" value="${ a.dexterity }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Luck</label>
                                                                    <input type="text" value="${ a.luck }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Intelligence</label>
                                                                    <input type="text" value="${ a.intelligence }">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="column">
                                                            <h2 class="ui centered header">${ b.name }</h2>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Class</label>
                                                                    <input type="text" value="${ b.class }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Level</label>
                                                                    <input type="text" value="${ b.level }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Minimum damage</label>
                                                                    <input type="text" value="${ b.damagemin }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Maximum damage</label>
                                                                    <input type="text" value="${ b.damagemax }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Strength</label>
                                                                    <input type="text" value="${ b.strength }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Constitution</label>
                                                                    <input type="text" value="${ b.constitution }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Dexterity</label>
                                                                    <input type="text" value="${ b.dexterity }">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Luck</label>
                                                                    <input type="text" value="${ b.luck }">
                                                                </div>
                                                            </div>
                                                            <div class="two fields">
                                                                <div class="field">
                                                                    <label>Intelligence</label>
                                                                    <input type="text" value="${ b.intelligence }">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="column">
                                                            ${ rounds.map((round, i) => `
                                                                    <div class="ui segment">
                                                                        <div class="ui grid">
                                                                            <div class="one wide column">${ i + 1 }</div>
                                                                            <div class="two wide column"><b>${ round.source.name }</b></div>
                                                                            <div class="one wide column">></div>
                                                                            <div class="two wide column"><b>${ round.target.name }</b></div>
                                                                            <div class="two wide column"></div>
                                                                            <div class="two wide column text-center ${ round.crit ? 'foreground-red' : '' }">${ round.type }</div>
                                                                            <div class="four wide column text-center ${ round.crit ? 'foreground-red' : '' }">${ round.damage }</div>
                                                                            <div class="two wide column"></div>
                                                                        </div>
                                                                    </div>
                                                                `).join('')
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `);
                                }
                            }

                            $('#fi-content').show();
                            $('.menu .item').tab();
                        } catch (e) {
                            $('#fi-error').show();
                            $('#fi-error').text(e);
                        }
                    };
                });
            })(jQuery);
        </script>
    </body>
</html>
