<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Viewer</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>

        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/components/state.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>

        <script src="js/core/playa.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>
        <div class="ui main container">
            <div class="ui middle aligned margin-medium-bottom grid">
                <div class="two wide column">
                    <label class="ui fluid button" for="fi-open">
                        <i class="upload icon"></i> Open
                    </label>
                    <input type="file" id="fi-open" multiple hidden>
                </div>
                <div class="two wide column">
                    <a class="ui fluid button" id="fi-clear"><i class="trash alternate outline icon"></i>Clear</a>
                </div>
                <div class="two wide column text-center">
                    <div class="ui icon buttons">
                        <button class="ui button" id="fi-copyall">
                            <i class="copy outline icon"></i>
                        </button>
                        <button class="ui button" id="fi-saveall">
                            <i class="save outline icon"></i>
                        </button>
                    </div>
                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Fight Viewer</h1>
                </div>
                <div class="four wide column">
                    <div class="ui form field">
                        <div class="ui selection fluid dropdown" style="height: 3.5em !important; margin-left: -2em !important; width: 22em !important;">
                            <input type="hidden" id="fi-select">
                            <i class="dropdown icon"></i>
                            <div class="default text"></div>
                            <div class="menu" id="fi-select-items">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="two wide column text-center">
                    <div class="ui icon buttons">
                        <button class="ui button" id="fi-copy">
                            <i class="copy outline icon"></i>
                        </button>
                        <button class="ui button" id="fi-save">
                            <i class="save outline icon"></i>
                        </button>
                    </div>
                </div>
            </div>
            <h3 class="ui centered header red" id="fi-error" hidden></h3>
            <div id="fi-content">
                    <div class="ui secondary grid" id="fi-select">

                    </div>
                <div id="fi-content-pages">

                </div>
            </div>
        </div>

        <script type="text/javascript">
            $('#fi-select').on('change', function () {
                $('[data-tab]').removeClass('active');
                $(`[data-tab="${ $(this).val() }"]`).addClass('active');
            });

            function copyToClipboard (... tabs) {
                var content = [];

                // Convert all tabs into tables
                for (var tab of tabs) {
                    var rows = [];

                    Object.entries(tab.fighterA).forEach(([key, val]) => {
                        if (val instanceof SFItem || val.DamageMin != undefined) {
                            rows.push([ key ]);
                            rows.push([ '', 'MinDmg', val.DamageMin ]);
                            rows.push([ '', 'MaxDmg', val.DamageMax ]);
                        } else if (key == 'Face') {
                            rows.push([ key, val.Mouth ]);
                        } else {
                            rows.push([ key, val ]);
                        }
                    });

                    Object.entries(tab.fighterB).forEach(([key, val]) => {
                        if (val instanceof SFItem || val.DamageMin != undefined) {
                            rows.push([ key ]);
                            rows.push([ '', 'MinDmg', val.DamageMin ]);
                            rows.push([ '', 'MaxDmg', val.DamageMax ]);
                        } else if (key == 'Face') {
                            rows.push([ key, val.Mouth ]);
                        } else {
                            rows.push([ key, val ]);
                        }
                    });

                    rows.push([ 'index', 'attacker', 'target', 'type', 'damage' ]);
                    tab.rounds.forEach((round, i) => {
                        rows.push([ i, round.attacker.ID, round.target.ID, ATTACK_TYPES[round.attackType], round.attackDamage ]);
                    });

                    content.push(rows);
                }

                var maxColumns = Math.max(... content[0].map(r => r.length));
                var maxRows = Math.max(... content.map(r => r.length));

                var rows = [];
                for (var c of content) {
                    for (var i = 0; i < maxRows; i++) {
                        var x = [];
                        if (c[i]) {
                            x.push(... c[i].map(y => `<td>${ y }</td>`));
                        }
                        while (x.length < maxColumns) {
                            x.push(`<td></td>`);
                        }
                        if (rows[i]) {
                            rows[i].push(...x);
                        } else {
                            rows[i] = x;
                        }
                    }
                }

                // Create element
                var el = document.createElement('table');
                el.innerHTML = `<tbody>${ rows.map(r => `<tr>${ r.join('') }</tr>`).join('') }</tbody>`;
                document.body.appendChild(el);

                // Create range, select element and copy
                var range = document.createRange();
                range.selectNode(el);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();

                // Destroy element
                document.body.removeChild(el);
            }

            $('#fi-select').val('');

            $('#fi-save').on('click', function () {
                if ($('[data-tab]').length == 0) return;
                var tab = tabs[$('[data-tab].active').attr('data-tab')];

                download(`${ tab.fighterA.Name }/${ tab.fighterB.Name }.json`, new Blob([
                    JSON.stringify({
                        targetA: tab.fighterA,
                        targetB: tab.fighterB,
                        rounds: tab.rounds.map(round => {
                            return {
                                attackCrit: round.attackCrit,
                                attackType: round.attackType,
                                attackMissed: round.attackMissed,
                                attackDamage: round.attackDamage,
                                attackSecondary: round.attackSecondary,
                                attacker: round.attacker.ID,
                                target: round.target.ID
                            };
                        })
                    })
                ], {
                    type: 'application/json'
                }));
            });

            $('#fi-saveall').on('click', function () {
                if ($('[data-tab]').length == 0) return;

                download(`fights.json`, new Blob([
                    JSON.stringify(tabs.map(tab => {
                        return {
                            targetA: tab.fighterA,
                            targetB: tab.fighterB,
                            rounds: tab.rounds.map(round => {
                                return {
                                    attackCrit: round.attackCrit,
                                    attackType: round.attackType,
                                    attackMissed: round.attackMissed,
                                    attackDamage: round.attackDamage,
                                    attackSecondary: round.attackSecondary,
                                    attacker: round.attacker.ID,
                                    target: round.target.ID
                                };
                            })
                        };
                    }))
                ], {
                    type: 'application/json'
                }));
            });

            $('#fi-copy').on('click', function () {
                if ($('[data-tab]').length == 0) return;
                copyToClipboard(tabs[$('[data-tab].active').attr('data-tab')]);
            });

            $('#fi-copyall').on('click', function () {
                if ($('[data-tab]').length == 0) return;
                copyToClipboard(... tabs);
            });

            var tabs = [];
            var tabsadded = false;

            function processData (critmult = 2) {
                var ranges = {};

                for (var tab of tabs) {
                    var rageoffset = 0;
                    for (var i = 0; i < tab.rounds.length; i++) {
                        var round = tab.rounds[i];
                        if (round.attackType == 100) {
                            rageoffset -= 1;
                        }

                        if (round.attackType != 100 && (round.attackType % 10 == 0 || round.attackType % 10 == 1)) {
                            if (round.attackType >= 20) {
                                rageoffset++;
                            }

                            var id = round.attacker.ID;
                            var rage = 1 + (i + rageoffset) / 6;
                            var crit = round.attackCrit ? critmult : 1;

                            var damage = Math.trunc((round.attackDamage / crit) / rage);
                            var second = round.attackType >= 10 && round.attackType <= 14;

                            if (second) {
                                id = id + '_2';
                            }

                            if (ranges[id] == undefined) {
                                ranges[id] = {
                                    min: damage,
                                    max: damage,
                                    name: round.attacker.Name
                                }
                            } else {
                                if (ranges[id].min > damage) {
                                    ranges[id].min = damage;
                                } else if (ranges[id].max < damage) {
                                    ranges[id].max = damage;
                                }
                            }
                        }
                    }
                }

                return ranges;
            }

            // Remove all tabs
            function clearTabs() {
                tabs = [];
            }

            // Add new tab
            function addTab(... tab) {
                tabs.push(... tab);
            }

            const RUNES = {
                40: 'Fire',
                41: 'Cold',
                42: 'Lightning'
            };

            // Update document
            function updateTabs() {
                for (var tab of tabs) {
                    tab.fighterA.Stats = {
                        Hits: 0,
                        Crits: 0,
                        Skips: 0
                    };

                    tab.fighterB.Stats = {
                        Hits: 0,
                        Crits: 0,
                        Skips: 0
                    };

                    for (var r of tab.rounds) {
                        if (r.attackType == 15 || r.attackType == 16) {
                            continue
                        }

                        if (r.attackMissed) {
                            r.attacker.Stats.Skips++;
                        } else {
                            r.attacker.Stats.Hits++;

                            if (r.attackCrit) {
                                r.attacker.Stats.Crits++;
                            }
                        }
                    }
                }

                if (tabs.length) {
                    $('#fi-content').show();
                    $('#fi-select-items').html(tabs.map((tab, index) => `<div class="item${ !tabsadded && index == 0 ? ' active selected' : '' }" data-value="${ index }"><div class="fi-wrap"><div class="fi-left">${ index + 1 }.</div><div class="fi-right"><span class="${ tab.winner.ID != tab.fighterA.ID ? 'foreground-red' : 'foreground-green' }">${ tab.fighterA.Name }</span></br><span class="${ tab.winner.ID != tab.fighterB.ID ? 'foreground-red' : 'foreground-green' }">${ tab.fighterB.Name }</span></div></div></div>`).join(''));
                    $('#fi-content-pages').html(tabs.map((tab, index) => `
                        <div class="ui tab basic segment${ !tabsadded && index == 0 ? ' active' : '' }${ index == 0 ? ' margin-medium-top' : '' }" data-tab="${ index }">
                            <div class="ui small form">
                                <div class="ui grid">
                                    <div class="two columns row">
                                        <div class="column">
                                            <h2 class="ui centered header ${ tab.winner.ID != tab.fighterA.ID ? 'foreground-red' : 'foreground-green' }">${ tab.fighterA.Name }</h2>
                                            <div class="two fields">
                                                <div class="field">
                                                    <label>Class</label>
                                                    <input type="text" value="${ PLAYER_CLASS[tab.fighterA.Class] }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Level</label>
                                                    <input type="text" value="${ tab.fighterA.Level }" disabled class="text-center">
                                                </div>
                                            </div>
                                            <div class="${ tab.fighterA.Wpn1.AttributeTypes[2] >= 30 ? 'four' : 'two' } fields">
                                                <div class="field">
                                                    <label>Minimum damage</label>
                                                    <input type="text" value="${ tab.fighterA.Wpn1.DamageMin || '' }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Maximum damage</label>
                                                    <input type="text" value="${ tab.fighterA.Wpn1.DamageMax || '' }" disabled class="text-center">
                                                </div>
                                                ${
                                                    tab.fighterA.Wpn1.AttributeTypes[2] >= 30 ? `
                                                        <div class="field">
                                                            <label>Element type</label>
                                                            <input type="text" value="${ RUNES[tab.fighterA.Wpn1.AttributeTypes[2]] }" disabled class="text-center">
                                                        </div>
                                                        <div class="field">
                                                            <label>Element value</label>
                                                            <input type="text" value="${ tab.fighterA.Wpn1.Attributes[2] }" disabled class="text-center">
                                                        </div>
                                                    ` : ''
                                                }
                                            </div>
                                            ${
                                                tab.fighterA.Wpn2.DamageMin && tab.fighterA.Class == 4 ? `
                                                    <div class="${ tab.fighterA.Wpn2.AttributeTypes[2] >= 30 ? 'four' : 'two' } fields">
                                                        <div class="field">
                                                            <label>Minimum damage</label>
                                                            <input type="text" value="${ tab.fighterA.Wpn2.DamageMin || '' }" disabled class="text-center">
                                                        </div>
                                                        <div class="field">
                                                            <label>Maximum damage</label>
                                                            <input type="text" value="${ tab.fighterA.Wpn2.DamageMax || '' }" disabled class="text-center">
                                                        </div>
                                                        ${
                                                            tab.fighterA.Wpn2.AttributeTypes[2] >= 30 ? `
                                                                <div class="field">
                                                                    <label>Element type</label>
                                                                    <input type="text" value="${ RUNES[tab.fighterA.Wpn2.AttributeTypes[2]]  }" disabled class="text-center">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Element value</label>
                                                                    <input type="text" value="${ tab.fighterA.Wpn2.Attributes[2] }" disabled class="text-center">
                                                                </div>
                                                            ` : ''
                                                        }
                                                    </div>
                                                ` : ''
                                            }
                                            <div class="five fields">
                                                <div class="field">
                                                    <label>Strength</label>
                                                    <input type="text" value="${ tab.fighterA.Strength }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Dexterity</label>
                                                    <input type="text" value="${ tab.fighterA.Dexterity }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Intelligence</label>
                                                    <input type="text" value="${ tab.fighterA.Intelligence }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Constitution</label>
                                                    <input type="text" value="${ tab.fighterA.Constitution }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Luck</label>
                                                    <input type="text" value="${ tab.fighterA.Luck }" disabled class="text-center">
                                                </div>

                                            </div>
                                            <div class="two fields">
                                                <div class="field">
                                                    <label>Health</label>
                                                    <input type="text" value="${ formatAsSpacedNumber(tab.fighterA.MaximumLife, ' ') }" disabled class="text-center">
                                                </div>
                                                ${ tab.fighterA.Life != tab.fighterA.MaximumLife ? `
                                                    <div class="field">
                                                        <label>Current Health</label>
                                                        <input type="text" value="${ formatAsSpacedNumber(tab.fighterA.Life, ' ') }" disabled class="text-center">
                                                    </div>
                                                ` : '' }
                                            </div>
                                            <div class="three fields">
                                                <div class="field">
                                                    <label>Total Hits</label>
                                                    <input type="text" value="${ tab.fighterA.Stats.Hits }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Critical Hits</label>
                                                    <input type="text" value="${ tab.fighterA.Stats.Crits }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Hits Evaded</label>
                                                    <input type="text" value="${ tab.fighterA.Stats.Skips }" disabled class="text-center">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column">
                                            <h2 class="ui centered header ${ tab.winner.ID != tab.fighterB.ID ? 'foreground-red' : 'foreground-green' }">${ tab.fighterB.Name }</h2>
                                            <div class="two fields">
                                                <div class="field">
                                                    <label>Class</label>
                                                    <input type="text" value="${ PLAYER_CLASS[tab.fighterB.Class] }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Level</label>
                                                    <input type="text" value="${ tab.fighterB.Level }" disabled class="text-center">
                                                </div>
                                            </div>
                                            <div class="${ tab.fighterB.Wpn1.AttributeTypes[2] >= 30 ? 'four' : 'two' } fields">
                                                <div class="field">
                                                    <label>Minimum damage</label>
                                                    <input type="text" value="${ tab.fighterB.Wpn1.DamageMin || '' }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Maximum damage</label>
                                                    <input type="text" value="${ tab.fighterB.Wpn1.DamageMax || '' }" disabled class="text-center">
                                                </div>
                                                ${
                                                    tab.fighterB.Wpn1.AttributeTypes[2] >= 30 ? `
                                                        <div class="field">
                                                            <label>Element type</label>
                                                            <input type="text" value="${ RUNES[tab.fighterB.Wpn1.AttributeTypes[2]] }" disabled class="text-center">
                                                        </div>
                                                        <div class="field">
                                                            <label>Element value</label>
                                                            <input type="text" value="${ tab.fighterB.Wpn1.Attributes[2] }" disabled class="text-center">
                                                        </div>
                                                    ` : ''
                                                }
                                            </div>
                                            ${
                                                tab.fighterB.Wpn2.DamageMin && tab.fighterB.Class == 4 ? `
                                                    <div class="${ tab.fighterB.Wpn2.AttributeTypes[2] >= 30 ? 'four' : 'two' } fields">
                                                        <div class="field">
                                                            <label>Minimum damage</label>
                                                            <input type="text" value="${ tab.fighterB.Wpn2.DamageMin || '' }" disabled class="text-center">
                                                        </div>
                                                        <div class="field">
                                                            <label>Maximum damage</label>
                                                            <input type="text" value="${ tab.fighterB.Wpn2.DamageMax || '' }" disabled class="text-center">
                                                        </div>
                                                        ${
                                                            tab.fighterB.Wpn2.AttributeTypes[2] >= 30 ? `
                                                                <div class="field">
                                                                    <label>Minimum damage</label>
                                                                    <input type="text" value="${ RUNES[tab.fighterB.Wpn2.AttributeTypes[2]]  }" disabled class="text-center">
                                                                </div>
                                                                <div class="field">
                                                                    <label>Maximum damage</label>
                                                                    <input type="text" value="${ tab.fighterB.Wpn2.Attributes[2] }" disabled class="text-center">
                                                                </div>
                                                            ` : ''
                                                        }
                                                    </div>
                                                ` : ''
                                            }
                                            <div class="five  fields">
                                                <div class="field">
                                                    <label>Strength</label>
                                                    <input type="text" value="${ tab.fighterB.Strength }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Dexterity</label>
                                                    <input type="text" value="${ tab.fighterB.Dexterity }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Intelligence</label>
                                                    <input type="text" value="${ tab.fighterB.Intelligence }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Constitution</label>
                                                    <input type="text" value="${ tab.fighterB.Constitution }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Luck</label>
                                                    <input type="text" value="${ tab.fighterB.Luck}" disabled class="text-center">
                                                </div>
                                            </div>
                                            <div class="two fields">
                                                <div class="field">
                                                    <label>Health</label>
                                                    <input type="text" value="${ formatAsSpacedNumber(tab.fighterB.MaximumLife, ' ') }" disabled class="text-center">
                                                </div>
                                                ${ tab.fighterB.Life != tab.fighterB.MaximumLife ? `
                                                    <div class="field">
                                                        <label>Current Health</label>
                                                        <input type="text" value="${ formatAsSpacedNumber(tab.fighterB.Life, ' ') }" disabled class="text-center">
                                                    </div>
                                                ` : '' }
                                            </div>
                                            <div class="three fields">
                                                <div class="field">
                                                    <label>Total Hits</label>
                                                    <input type="text" value="${ tab.fighterB.Stats.Hits }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Critical Hits</label>
                                                    <input type="text" value="${ tab.fighterB.Stats.Crits }" disabled class="text-center">
                                                </div>
                                                <div class="field">
                                                    <label>Hits Evaded</label>
                                                    <input type="text" value="${ tab.fighterB.Stats.Skips }" disabled class="text-center">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="column">
                                            ${ tab.rounds.map((round, i) => `
                                                    <div class="ui basic segment ${ i % 2 ? 'undertone' : '' }">
                                                        <div class="ui grid">
                                                            <div class="one wide column"></div>
                                                            <div class="one wide column">${ i + 1 }</div>
                                                            <div class="three wide column text-right"><b>${ round.attacker.Name }</b></div>
                                                            <div class="one wide column text-center">></div>
                                                            <div class="three wide column"><b>${ round.target.Name }</b></div>
                                                            <div class="one wide column"></div>
                                                            <div class="two wide column text-center ${ round.attackCrit ? 'foreground-red' : '' } ${ round.attackType == 100 ? 'text-purple' : '' }">${ ATTACK_TYPES[round.attackType] }</div>
                                                            <div class="three wide column text-right ${ round.attackCrit ? 'foreground-red text-bold' : '' }">${ round.attackDamage ? formatAsSpacedNumber(round.attackDamage, ' ') : '' }</div>
                                                            <div class="one wide column"></div>
                                                        </div>
                                                    </div>
                                                `).join('')
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join(''));
                    if (!tabsadded) {
                        $('#fi-select').val('0');
                    } else {
                        $('#fi-select').trigger('change');
                    }
                    tabsadded = true;
                } else {
                    $('.dropdown').dropdown();
                    $('#fi-content').hide();
                    $('#fi-select-items').html('');
                    $('#fi-content-pages').html('');
                    $('#fi-select').parent('.dropdown').children('.text').text('');
                    tabsadded = false;
                }

                $('.dropdown').dropdown();
            }

            // Clear error
            function clearError() {
                $('#fi-error').hide();
                $('#fi-error').text('');
            }

            // Show error
            function showError(msg) {
                $('#fi-error').show();
                $('#fi-error').text(msg);
            }

            // Parse file
            function parseTabs(json) {
                var fights = [];
                var raws = [];

                for (var [k, v] of filterPlayaJSON(json)) {
                    if (k == 'text' && v.includes('fightheader')) {
                        var cr = [];
                        for (var [kb, vb] of parsePlayaResponse(v)) {
                            if (kb.includes('.fighters')) {
                                cr.push(['fighters', vb].join(':'));
                            } else if (kb.includes('.r')) {
                                cr.push(['r', vb].join(':'));
                            } else if (kb.includes('winnerid')) {
                                cr.push(['winnerid', vb].join(':'));
                                raws.push(cr.join('&'));
                                cr = [];
                            }
                        }
                    }
                }

                for (var raw of raws) {
                    var msg = {};
                    for (var [k, v] of parsePlayaResponse(raw)) {
                        msg[k] = v.split(/[/,]/g).map(d => isNaN(d) ? d : Number(d));
                    }

                    if (msg['fighters'] && msg['winnerid'] && msg['r'] && Object.values(FIGHT_TYPES).includes(msg['fighters'][0])) {
                        var fightType = msg['fighters'][0];

                        // Fighter A (always a player)
                        var fighterA = new SFFighter(msg['fighters'].slice(5, 52));
                        if (fighterA.isMonster()) {
                            fighterA.Name = getFightTargetName(fightType, fighterA.Name, fighterA.getMonsterID());
                        }

                        // Fighter B (player or monster)
                        var fighterB = new SFFighter(msg['fighters'].slice(52, 99));
                        if (fighterB.isMonster() || !isNaN(fighterB.Name)) {
                            fighterB.Name = getFightTargetName(fightType, fighterB.Name, fighterB.getMonsterID())
                        }

                        // Winner
                        var winner = msg['winnerid'][0] == fighterA.ID ? fighterA : fighterB;

                        // Looping though all rounds
                        var rounds = [];
                        for (var i = 0; i < msg['r'].length / 3; i++) {
                            var [
                                attackerID,
                                attackType,
                                targetHealthLeft
                            ] = msg['r'].slice(i * 3, i * 3 + 3);
                            rounds.push({
                                attacker: attackerID == fighterA.ID ? fighterA : fighterB,
                                target: attackerID == fighterA.ID ? fighterB : fighterA,
                                attackType: attackType,
                                attackSecondary: attackType >= 10 && attackType <= 14,
                                attackCrit: attackType % 10 == 1,
                                attackMissed: (attackType % 10 == 3) || (attackType % 10 == 4),
                                targetHealthLeft: targetHealthLeft
                            });
                        }

                        for (var i = 0, round; round = rounds[i]; i++) {
                            round.attackDamage = (() => {
                                for (var j = i - 1; j >= 0; j--) {
                                    if (rounds[j].attacker == round.attacker) {
                                        return rounds[j].targetHealthLeft;
                                    }
                                }

                                return round.target.Life;
                            })() - round.targetHealthLeft;

                            if (round.attackType == 100) {
                                round.attackDamage = 0;
                            }
                        }

                        fights.push({
                            fighterA: fighterA,
                            fighterB: fighterB,
                            rounds: rounds,
                            winner: winner
                        });
                    }
                }

                return fights;
            }

            function reimport(json) {
                return json.map(f => {
                    return {
                        fighterA: f.targetA,
                        fighterB: f.targetB,
                        winner: f.rounds[f.rounds.length - 1].target == f.targetA.ID ? f.targetB : f.targetA,
                        rounds: f.rounds.map(r => {
                            return {
                                attackCrit: r.attackCrit,
                                attackType: r.attackType,
                                attackMissed: r.attackMissed,
                                attackDamage: r.attackDamage,
                                attackSecondary: r.attackSecondary,
                                attacker: r.attacker == f.targetA.ID ? f.targetA : f.targetB,
                                target: r.target == f.targetA.ID ? f.targetA : f.targetB
                            };
                        })
                    };
                });
            }

            // Event handlers
            $('#fi-open').on('change', function () {
                Array.from(this.files).forEach(file => {
                    var r = new FileReader();
                    r.readAsText(file, 'UTF-8');
                    r.onload = event => {
                        try {
                            clearError();

                            var data = JSON.parse(event.target.result);
                            if (data.rounds) {
                                addTab(... reimport([ data ]));
                            } else if (Array.isArray(data)) {
                                addTab(... reimport(data));
                            } else {
                                addTab(... parseTabs(data));
                            }

                            updateTabs();
                        } catch (exception) {
                            showError(exception);
                        }
                    };
                });
            });

            $('#fi-clear').on('click', function () {
                clearTabs();
                updateTabs();
            });
        </script>
    </body>
</html>
