<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">

	<title>SF Miner Utility</title>

	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/mdb.min.css" rel="stylesheet">

    <link href="css/style.css" rel="stylesheet">
</head>

<body>
	<header>
		<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
			<a class="navbar-brand text-white">SF Miner Utility</a>
		</nav>
	</header>

	<main role="main">
		<div class="container mw-100 px-5">
            <div class="border border-dark rounded p-3 my-3">
                <label class="mt-3">Data</label>
                <textarea class="form-control" id="digdata" rows="2" style="font-size: 80%;"></textarea>
				<small class="form-text text-muted">Separate values using /. Use comma to separate individual data entries.</small>
				<label class="mt-1" >Ignored fields</label>
                <input type="text" class="form-control" id="digfil">
				<small class="form-text text-muted">Separate using comma, use - for range.</small>
                <label class="mt-1" >Requested value</label>
                <input type="text" class="form-control" id="digval">
				<small class="form-text text-muted">Separate using comma.</small>
				<button type="button" class="btn btn-dark btn-sm rounded mr-2 custom-control-inline" id="refresh">Refresh</button>
				<div class="custom-control custom-checkbox custom-control-inline mb-2 mt-3">
					<input type="checkbox" class="custom-control-input" id="onlyfull">
					<label class="custom-control-label" for="onlyfull">Show only common entries</label>
				</div>
				<div class="custom-control custom-checkbox custom-control-inline mb-2 mt-3">
					<input type="checkbox" class="custom-control-input" id="filteroff">
					<label class="custom-control-label" for="filteroff">Ignore filter</label>
				</div>
            </div>
            <div id="digout" class="px-5"></div>
		</div>
	</main>

	<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="js/popper.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/mdb.min.js"></script>

    <script>
		function funRemainder(returns, target, num, func)
		{
			for (var i = 4; i <= 16; i++)
			{
				var res = num % Math.pow(2, i);

				if (target === res)
				{
					returns.push(`(${func}) % ${Math.pow(2, i)}`);
				}
			}
		}

		function funDivision(returns, target, num, func)
		{
			for (var i = 4; i <= 16; i++)
			{
				var res = num / Math.pow(2, i);

				if (target === res)
				{
					returns.push(`(${func}) / ${Math.pow(2, i)}`);
				}
			}
		}

		function funSingle(target, num)
		{
			var returns = [];

			if (target === num)
			{
				returns.push(`x`);
			}

			funDivision(returns, target, num, 'x');
			funRemainder(returns, target, num, 'x');

			for (var i = 4; i <= 16; i++)
			{
				funDivision(returns, target, num % Math.pow(2, i), `x % ${Math.pow(2, i)}`);
				funRemainder(returns, target, num / Math.pow(2, i), `x / ${Math.pow(2, i)}`);
				funDivision(returns, target, num / Math.pow(2, i), `x / ${Math.pow(2, i)}`);
				funRemainder(returns, target, num - num % Math.pow(2, i), `x - x % ${Math.pow(2, i)}`);
				funDivision(returns, target, num - num % Math.pow(2, i), `x - x % ${Math.pow(2, i)}`);
				for (var j = 4; j <= 16; j++)
				{
					funRemainder(returns, target, num / Math.pow(2, i) - (num / Math.pow(2, i)) % Math.pow(2, j), `x / ${Math.pow(2, i)} - (x / ${Math.pow(2, i)}) % ${Math.pow(2, j)}`);
				}
				for (var j = 4; j <= 16; j++)
				{
					funDivision(returns, target, num / Math.pow(2, i) - (num / Math.pow(2, i)) % Math.pow(2, j), `x / ${Math.pow(2, i)} - (x / ${Math.pow(2, i)}) % ${Math.pow(2, j)}`);
				}
			}

			return returns;
		}

		function fun(out, targets, numbers, filter)
		{
			if (!targets.length || !numbers.length)
			{
				return 'Fields cannot be empty';
			}
			else if ((targets.length > 1 && targets.length != numbers.length && numbers.length > 1) || (targets.length > 1 && numbers.length != 1))
			{
				return 'Fields must have equal lengths';
			}
			else
			{
				for (var i = 0; i < numbers.length; i++)
				{
					if (numbers[0].length != numbers[i].length)
					{
						return 'Data must have equal lengths';
					}
				}

				if (targets.length == 1)
				{
					for (var i = 0; i < numbers[0].length; i++)
					{
						var outs = [];

						for (var j = 0; j < numbers.length; j++)
						{
							outs.push({
								number: numbers[j][i],
								target: targets[0],
								output: funSingle(targets[0], numbers[j][i])
							});
						}

						out.push(outs);
					}
				}
				else if (numbers.length == 1)
				{
					for (var i = 0; i < numbers[0].length; i++)
					{
						var outs = [];

						for (var j = 0; j < targets.length; j++)
						{
							outs.push({
								number: numbers[0][i],
								target: targets[j],
								output: funSingle(targets[j], numbers[0][i])
							});
						}

						out.push(outs);
					}
				}
				else
				{
					for (var i = 0; i < numbers[0].length; i++)
					{
						var outs = [];

						for (var j = 0; j < numbers.length; j++)
						{
							outs.push({
								number: numbers[j][i],
								target: targets[j],
								output: funSingle(targets[j], numbers[j][i])
							});
						}

						out.push(outs);
					}
				}
			}
		}

		function work()
		{
			$('#digout').empty();

			if (!$('#digval').val()) return;
			if ($('#digdata').val().length == 0) return;

			var showcommon = $('#onlyfull').prop('checked');
			var ignorefilter = $('#filteroff').prop('checked');

			var targets = $('#digval').val().split(',').map(a => Number(a));
			for (var i = 0; i < targets.length; i++) if (!targets[i]) targets.splice(i--, 1);

			var filterraw = $('#digfil').val().length > 0 ? $('#digfil').val().split(',') : [];
			var filter = [];
			for (var i = 0; i < filterraw.length; i++) {
				if (filterraw[i].includes('-')) {
					var [x,y] = filterraw[i].split('-').map(a => Number(a));
					for (var j = x; j <= y; j++) filter.push(j);
				} else filter.push(Number(filterraw[i]));
			}

			var dataraw = $('#digdata').val().split(',');
			var data = [];
			for (var i = 0; i < dataraw.length; i++) {
				data.push(dataraw[i].split('/').map(a => Number(a)));
			}

			var ows = [];
			var res = fun(ows, targets, data, filter);
			var out = [];

			if (res)
			{
				out.push(`<h5 class="text-danger">${res}</h5>`);
			}
			else
			{
				for (var i = 0, block; block = ows[i]; i++)
				{
					if (filter.includes(i) && !ignorefilter) continue;

					var any = block.map(a => a.output.length).reduce((a, b) => a + b, 0) > 0;
					var all = block.map(a => a.output.length > 0 ? 1 : 0).reduce((a, b) => a + b, 0) == block.length;

					if ((any && !showcommon) || (all && showcommon))
					{
						out.push(`<div class="rounded mt-2 ${all ? 'bg-dark text-white' : 'bg-warning text-dark'} row"><div class="col-1">${i}</div>`);

						for (var j = 0; j < block.length; j++)
						{
							out.push(`<div class="col text-center">${block[j].number} (${block[j].target})</div>`);
						}

						out.push(`</div><div class="row"><div class="col-1"></div>`);

						for (var j = 0; j < block.length; j++)
						{
							out.push('<div class="col" style="font-size: 75%;">');

							for (var k = 0; k < block[j].output.length; k++)
							{
								out.push(`<div class="row"><div class="col text-center">${block[j].output[k]}</div></div>`);
							}

							out.push('</div>');
						}

						out.push('</div>');
					}
				}
			}

			$('#digout').html(out.join(''));
		}

		$('#refresh').on('click', work);
		$('#filteroff, #onlyfull').on('input', work);
		$('#digval, #digdata, #digfil').on('change input', work);
    </script>
</body>

</html>
