<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">

	<title>SF Miner Utility</title>

	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/mdb.min.css" rel="stylesheet">

    <link href="css/style.css" rel="stylesheet">
</head>

<body>
	<header>
		<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
			<a class="navbar-brand text-white">SF Miner Utility</a>
		</nav>
	</header>

	<main role="main" class="flex-shrink-0">
		<div class="container">
            <div class="border border-dark rounded p-3 my-3">
                <label class="mt-3">Data</label>
                <textarea class="form-control" id="digdata" rows="2" style="font-size: 80%;"></textarea>
				<small class="form-text text-muted">Separate values using /. Use comma to separate individual data entries.</small>
				<label class="mt-1" >Ignored fields</label>
                <input type="text" class="form-control" id="digfil">
				<small class="form-text text-muted">Separate using comma, use - for range.</small>
                <label class="mt-1" >Requested value</label>
                <input type="text" class="form-control" id="digval">
				<small class="form-text text-muted">Separate using comma.</small>
				<button type="button" class="btn btn-dark btn-sm rounded mr-2 custom-control-inline" id="refresh">Refresh</button>
				<div class="custom-control custom-checkbox custom-control-inline mb-2 mt-3">
					<input type="checkbox" class="custom-control-input" id="onlyfull">
					<label class="custom-control-label" for="onlyfull">Show only common entries</label>
				</div>
				<div class="custom-control custom-checkbox custom-control-inline mb-2 mt-3">
					<input type="checkbox" class="custom-control-input" id="filteroff">
					<label class="custom-control-label" for="filteroff">Ignore filter</label>
				</div>
            </div>
            <div id="digout" class="px-5"></div>
		</div>
	</main>

	<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="js/popper.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/mdb.min.js"></script>

    <script>
		function funRemainder(returns, target, num, func)
		{
			for (var i = 4; i <= 16; i++)
			{
				var res = num % Math.pow(2, i);

				if (target === res)
				{
					returns.push(`(${func}) % ${Math.pow(2, i)}`);
				}
			}
		}

		function funDivision(returns, target, num, func)
		{
			for (var i = 4; i <= 16; i++)
			{
				var res = num / Math.pow(2, i);

				if (target === res)
				{
					returns.push(`(${func}) / ${Math.pow(2, i)}`);
				}
			}
		}

		function funSingle(target, num)
		{
			var returns = [];

			if (target === num)
			{
				returns.push(`x`);
			}

			funDivision(returns, target, num, 'x');
			funRemainder(returns, target, num, 'x');

			for (var i = 4; i <= 16; i++)
			{
				funDivision(returns, target, num % Math.pow(2, i), `x % ${Math.pow(2, i)}`);
				funRemainder(returns, target, num / Math.pow(2, i), `x / ${Math.pow(2, i)}`);
				funDivision(returns, target, num / Math.pow(2, i), `x / ${Math.pow(2, i)}`);
				funRemainder(returns, target, num - num % Math.pow(2, i), `x - x % ${Math.pow(2, i)}`);
				funDivision(returns, target, num - num % Math.pow(2, i), `x - x % ${Math.pow(2, i)}`);
				for (var j = 4; j <= 16; j++)
				{
					funRemainder(returns, target, num / Math.pow(2, i) - (num / Math.pow(2, i)) % Math.pow(2, j), `x / ${Math.pow(2, i)} - (x / ${Math.pow(2, i)}) % ${Math.pow(2, j)}`);
				}
				for (var j = 4; j <= 16; j++)
				{
					funDivision(returns, target, num / Math.pow(2, i) - (num / Math.pow(2, i)) % Math.pow(2, j), `x / ${Math.pow(2, i)} - (x / ${Math.pow(2, i)}) % ${Math.pow(2, j)}`);
				}
			}

			return returns;
		}

		$('#refresh').on('click', function() {
			$('#digval').trigger('input');
		});

		$('#filteroff, #onlyfull').on('input', function() {
			$('#digval').trigger('input');
		});

		$('#digval, #digdata, #digfil').on('change input', function() {
			$('#digout').empty();

			if (!$('#digval').val() || $('#digdata').val().length == 0) return;

			var onlyall = $('#onlyfull').prop('checked');

			var targets = $('#digval').val().split(',').map(a => Number(a));
			for (var i = 0; i < targets.length; i++)
			{
				if (!targets[i])
				{
					targets.splice(i, 1);
					i--;
				}
			}

			var rawFilter = $('#digfil').val().length > 0 ? $('#digfil').val().split(',') : [];
			var filter = [];
			var filteroff = $('#filteroff').prop('checked');

			for (var i = 0; i < rawFilter.length && !filteroff; i++)
			{
				if (rawFilter[i].includes('-'))
				{
					var [x, y] = rawFilter[i].split('-').map(v => Number(v));
					for (var j = x; j <= y; j++)
					{
						filter.push(j);
					}
				}
				else
				{
					filter.push(Number(rawFilter[i]));
				}
			}

			var content = [];

			var rawdata = $('#digdata').val().split(',');
			var data = [];
			for (var i = 0; i < rawdata.length; i++)
			{
				data.push(rawdata[i].split('/').map(a => Number(a)));
			}

			for (var i = 0; i < data[0].length; i++)
			{
				if (!filter.includes(i))
				{
					var results = [];
					if (targets.length == 1)
					{
						for (var j = 0; j < data.length; j++)
						{
							results.push(funSingle(targets[0], data[j][i]));
						}
					}
					else
					{
						if (data.length == 1)
						{
							for (var j = 0; j < targets.length; j++)
							{
								results.push(funSingle(targets[j], data[0][i]));
							}
						}
						else
						{
							for (var j = 0; j < data.length; j++)
							{
								results.push(funSingle(targets[j], data[j][i]));
							}
						}
					}

					var hasresults = 0;
					var hasall = true;
					for (var j = 0; j < results.length; j++)
					{
						hasresults += results[j].length;
						hasall &= results[j].length > 0;
					}

					if ((!onlyall && hasresults > 0) || (onlyall && hasall))
					{
						content.push(`<div class="rounded mt-2 ${hasall ? 'bg-dark text-white' : 'bg-warning text-dark'} row"><div class="col-1">${i}</div>`);

						for (var j = 0; j < data.length; j++)
						{
							content.push(`<div class="col text-center">${data[j][i]}</div>`);
						}

						content.push('</div><div class="row">');

						for (var j = 0; j < results.length; j++)
						{
							content.push('<div class="col-1"></div><div class="col" style="font-size: 75%;">');

							for (var k = 0; k < results[j].length; k++)
							{
								content.push(`<div class="row"><div class="col text-center">${results[j][k]}</div></div>`);
							}

							content.push('</div>');
						}

						content.push('</div>');
					}
				}
			}

			$('#digout').html(content.join(''));
		});
    </script>
</body>

</html>
