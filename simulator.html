<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Simulator</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/html2canvas.js"></script>

        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/components/state.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>

        <script src="js/core/playa.js"></script>
        <script src="js/core/simulator.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">

        <style>
            .bordered .fields:last-of-type {
                margin-bottom: 0;
            }

            .bordered {
                padding: 0.5em;
                margin-bottom: 0.5em;
            }

            .bordered-simple {
                margin-bottom: 0.35em;
                padding-top: 0.5em !important;
                padding-bottom: 0.5em !important;
                margin-right: 1em;
                margin-left: 1em;
            }

            .bnone {
                border: 1px solid transparent;
            }

            .bone {
                border: 1px solid orange;
            }

            .btwo {
                border: 1px solid purple;
            }

            .bthree {
                border: 1px solid blue;
            }

            .bfour {
                border: 1px solid red;
            }

            .bfive {
                border: 1px solid green;
            }

            .bsix {
                border: 1px solid pink;
            }

            .spaced {
                margin-top: 2em !important;
            }

            .selectable {
                -moz-user-select: -moz-none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                padding-bottom: 0.25em !important;
                padding-top: 0.25em !important;
            }

            .selectable div {
                padding: 0 !important;
            }

            .selectable-header div {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            .selected {
                background-color: rgba(0, 0, 0, 0.1);
                cursor: pointer;
            }

            .nselected {
                cursor: pointer;
            }

            [data-sort-style] {
                position: relative;
                margin-top: -15px;
                padding-top: 15px;
                margin-bottom: -15px;
                padding-bottom: 15px;
                margin-right: -10px;
                padding-right: 10px;
                margin-left: -10px;
                padding-left: 10px;
            }

            [data-sort-style="1"]::before {
                content: "\f0de";
                font-family: Icons;
                position: absolute;
                left: 1px;
                top: -3px;
                transform: scale(0.7);
            }

            [data-sort-style="2"]::before {
                content: "\f0dd";
                font-family: Icons;
                position: absolute;
                left: 1px;
                bottom: 0px;
                transform: scale(0.7);
            }

            .debug {
                position: absolute;
                top: 5em;
                left: 1em;
                font-size: 80%;
            }
        </style>
    </head>
    <body class="margin-none-bottom">
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>

        <div class="debug">

        </div>

        <div class="ui main container">
            <!-- Header -->
            <div class="ui five columns middle aligned grid">
                <div class="two wide column">

                </div>
                <div class="four wide column">

                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Fight Simulator</h1>
                </div>
                <div class="four wide column">

                </div>
                <div class="two wide wide column">

                </div>
            </div>
            <div class="ui two columns grid">
                <!-- Player edit field -->
                <div class="column">
                    <div class="ui form" id="sim-editor">
                        <div class="bordered bone">
                            <div class="field">
                                <label>Name</label>
                                <input class="text-center" type="text" data-path="Name" data-type="string">
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Class</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" value="1" data-type="number1" data-path="Class">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="1">Warrior</div>
                                            <div class="item" data-value="2">Mage</div>
                                            <div class="item" data-value="3">Scout</div>
                                            <div class="item" data-value="4">Assassin</div>
                                            <div class="item" data-value="5">Battle Mage</div>
                                            <div class="item" data-value="6">Berserker</div>
                                            <div class="item" data-value="7">Demon Hunter</div>
                                            <div class="item disabled" data-value="8">Druid</div>
                                            <div class="ui divider"></div>
                                            <div class="item" data-value="20">Necromancer</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Level</label>
                                    <input class="text-center" type="text" data-path="Level">
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field">
                                    <label>Str</label>
                                    <input class="text-center" type="text" data-path="Strength.Total">
                                </div>
                                <div class="field">
                                    <label>Dex</label>
                                    <input class="text-center" type="text" data-path="Dexterity.Total">
                                </div>
                                <div class="field">
                                    <label>Int</label>
                                    <input class="text-center" type="text" data-path="Intelligence.Total">
                                </div>
                                <div class="field">
                                    <label>Con</label>
                                    <input class="text-center" type="text" data-path="Constitution.Total">
                                </div>
                                <div class="field">
                                    <label>Lck</label>
                                    <input class="text-center" type="text" data-path="Luck.Total">
                                </div>
                            </div>
                        </div>
                        <div class="bordered btwo">
                            <div class="five fields">
                                <div class="field">
                                    <label>Min</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn1.DamageMin">
                                </div>
                                <div class="field">
                                    <label>Max</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn1.DamageMax">
                                </div>
                                <div class="field">
                                    <label>Crit</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" value="false" data-path="Items.Wpn1.HasEnchantment" data-type="bool">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="false">No</div>
                                            <div class="item" data-value="true">Yes</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Rune</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" value="0" data-type="number" data-path="Items.Wpn1.AttributeTypes.2">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="0">None</div>
                                            <div class="item" data-value="40">Fire</div>
                                            <div class="item" data-value="41">Cold</div>
                                            <div class="item" data-value="42">Lightning</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label></br></label>
                                    <input class="text-center" type="text" data-path="Items.Wpn1.Attributes.2">
                                </div>
                            </div>
                        </div>
                        <div class="bordered bthree" data-optional="Weapon2">
                            <div class="five fields">
                                <div class="field">
                                    <label>Min</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn2.DamageMin">
                                </div>
                                <div class="field">
                                    <label>Max</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn2.DamageMax">
                                </div>
                                <div class="field">
                                    <label>Crit</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" value="false" data-path="Items.Wpn2.HasEnchantment" data-type="bool">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="false">No</div>
                                            <div class="item" data-value="true">Yes</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Rune</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" data-type="number" value="0" data-path="Items.Wpn2.AttributeTypes.2">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="0">None</div>
                                            <div class="item" data-value="40">Fire</div>
                                            <div class="item" data-value="41">Cold</div>
                                            <div class="item" data-value="42">Lightning</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label></br></label>
                                    <input class="text-center" type="text" data-path="Items.Wpn2.Attributes.2">
                                </div>
                            </div>
                        </div>
                        <div class="bordered bfour">
                            <div class="four fields">
                                <div class="field">
                                    <label>Armor</label>
                                    <input class="text-center" type="text" data-path="Armor">
                                </div>
                                <div class="field">
                                    <label>Fire</label>
                                    <input class="text-center" type="text" data-path="Runes.ResistanceFire">
                                </div>
                                <div class="field">
                                    <label>Cold</label>
                                    <input class="text-center" type="text" data-path="Runes.ResistanceCold">
                                </div>
                                <div class="field">
                                    <label>Lightning</label>
                                    <input class="text-center" type="text" data-path="Runes.ResistanceLightning">
                                </div>
                            </div>
                        </div>
                        <div class="bordered bfive">
                            <div class="three fields">
                                <div class="field">
                                    <label>Portal Health</label>
                                    <input class="text-center" type="text" data-path="Dungeons.Player">
                                </div>
                                <div class="field">
                                    <label>Rune Health</label>
                                    <input class="text-center" type="text" data-path="Runes.Health">
                                </div>
                                <div class="field">
                                    <label>Life Potion</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" value="0" data-type="number" data-path="Potions.Life">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="0">No</div>
                                            <div class="item" data-value="25">Yes</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bordered bsix">
                            <div class="three fields">
                                <div class="field">
                                    <label>Portal Damage</label>
                                    <input class="text-center" type="text" data-path="Dungeons.Group">
                                </div>
                                <div class="field">
                                    <label>Gladiator</label>
                                    <input class="text-center" type="text" data-path="Fortress.Gladiator">
                                </div>
                                <div class="field">
                                    <label>Shadow of the Cowboy</label>
                                    <div class="ui selection compact dropdown">
                                        <input class="text-center" type="hidden" value="false" data-path="Items.Hand.HasEnchantment" data-type="bool">
                                        <i class="dropdown icon"></i>
                                        <div class="default text"></div>
                                        <div class="menu">
                                            <div class="item" data-value="false">No</div>
                                            <div class="item" data-value="true">Yes</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Player list -->
                <div class="column">
                    <div class="ui grid">
                        <div class="css-small-row row">
                            <div class="five wide column">
                                <button class="ui fluid small button" type="submit" id="sim-add"><i class="small arrow right icon"></i> Add player</button>
                            </div>
                            <div class="five wide column">
                                <button class="ui fluid small button" type="submit" id="sim-save">Save</button>
                            </div>
                            <div class="two wide column">
                                <button class="ui tiny basic icon fluid button" data-position="bottom center" data-tooltip="Toggle Add/Replace insertion mode" id="sim-insert"><i class="paste icon"></i></button>
                            </div>
                            <div class="four wide column">
                                <div class="ui tiny basic icon fluid two buttons">
                                    <button class="ui button" data-position="bottom center" data-tooltip="Copy current" id="sim-copy"><i class="outline copy icon"></i> 1</button>
                                    <button class="ui button" data-position="bottom center" data-tooltip="Copy everyone" id="sim-copyall"><i class="copy icon"></i> All</button>
                                </div>
                            </div>
                        </div>
                        <div class="css-small-row row">
                            <div class="five wide column">
                                <div class="ui small form">
                                    <div class="field" data-tooltip="Amount of fights per two players. Use lower value if using simulator with large amount of people.">
                                        <input class="text-center fluid" type="text" id="sim-iterations" value="10000">
                                    </div>
                                </div>
                            </div>
                            <div class="five wide column">
                                <div class="ui form">
                                    <div class="field">
                                        <div class="ui fluid selection compact dropdown">
                                            <input class="text-center" type="hidden" value="0" id="sim-mode">
                                            <i class="dropdown icon"></i>
                                            <div class="default text"></div>
                                            <div class="menu">
                                                <div class="item" data-value="0">All vs All</div>
                                                <div class="item" data-value="1">One vs All</div>
                                                <div class="item" data-value="2">Tournament</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="two wide column">

                            </div>
                            <div class="four wide column">
                                <button class="ui fluid small button" type="submit" id="sim-run">Simulate</button>
                            </div>
                        </div>
                        <div class="row clickable selectable-header">
                            <div class="two wide text-center column">
                                <span data-sort="class">
                                    Class
                                </span>
                            </div>
                            <div class="two wide column">
                                <span data-sort="level">
                                    Level
                                </span>
                            </div>
                            <div class="four wide column">
                                <span data-sort="name">
                                    Name
                                </span>
                            </div>
                            <div class="two wide text-center column">
                                <span data-sort="avg">
                                    Win %
                                </span>
                            </div>
                            <div class="two wide text-center column">
                                <span data-sort="min">
                                    Min %
                                </span>
                            </div>
                            <div class="two wide text-center column">
                                <span data-sort="max">
                                    Max %
                                </span>
                            </div>
                            <div class="one wide column">

                            </div>
                            <div class="one wide column">

                            </div>
                        </div>
                        <div class="row padding-none">
                            <div class="sixteen wide column">
                                <hr/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="sixteen wide column">
                                <div class="ui middle aligned grid" id="sim-players">

                                </div>
                            </div>
                        <div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            // Init
            $('#sim-mode').val(0);

            //$('.dropdown').dropdown();
            $('[data-path="Class"]').change(function () {
                $('.dropdown').dropdown();
                $('[data-optional="Weapon2"]').toggle($(this).val() == 4);
            }).trigger('change');
            $('[data-path]').on('input', () => valid());

            var insertMode = false;
            $('#sim-insert').click(function () {
                insertMode = !insertMode;
                if (insertMode) {
                    this.style.setProperty('background', '#21ba45', 'important');
                } else {
                    this.style.setProperty('background', '');
                }
            });

            // Fill and read forms
            function fill (object) {
                $('[data-path]').each(function () {
                    $(this).val(getObjectAt(object, $(this).attr('data-path')));
                });

                $('[data-path="Class"]').trigger('change');
            }

            function clear () {
                $('[data-path]').each(function () {
                    var type = $(this).attr('data-type');
                    if (type == 'bool') {
                        $(this).val('false');
                    } else if (type == 'number') {
                        $(this).val('0');
                    } else if (type == 'number1') {
                        $(this).val('1');
                    } else {
                        $(this).val('');
                    }
                });

                $('[data-path="Class"]').trigger('change');
            }

            function toggleAll (dis) {
                if (dis) {
                    $('.ui.main.container').addClass('frozen');
                } else {
                    $('.ui.main.container').removeClass('frozen');
                }
            }

            function logClear () {
                $('.debug').html('');
            }

            function logLine (line) {
                $('.debug').append(`${ line }</br>`);
            }

            function read () {
                var object = new SFPlayer();
                $('#sim-editor').find('[data-path]').each(function () {
                    var key = $(this).attr('data-path');
                    var type = $(this).attr('data-type');
                    var val = $(this).val();

                    if (type == 'bool') {
                        setObjectAt(object, key, val == 'true');
                    } else if (type == 'string') {
                        setObjectAt(object, key, val);
                    } else {
                        setObjectAt(object, key, Number(val));
                    }
                });
                return object;
            }

            function valid () {
                return $('[data-path]').toArray().reduce((errors, element) => {
                    var key = $(element).attr('data-path');
                    var type = $(element).attr('data-type');
                    var val = $(element).val();

                    if (type == 'bool' || type == 'string' || !isNaN(val)) {
                        $(element).parent('.field').removeClass('error');
                        return errors;
                    } else {
                        $(element).parent('.field').addClass('error');
                        return errors + 1;
                    }
                }, 0) == 0;
            }

            // On paste event handler
            $('#sim-editor input').on('paste', function (event) {
                event.stopPropagation();
            });

            // Helper function
            function merge (a, b) {
                for (var [k, v] of Object.entries(b)) {
                    if (!a.hasOwnProperty(k)) a[k] = b[k];
                }

                return a;
            }

            $(document.body).on('paste', function (event) {
                try {
                    var data = JSON.parse(event.originalEvent.clipboardData.getData('text'));
                    if (Array.isArray(data)) {
                        if (!insertMode) {
                            players = [];
                        }

                        for (var d of data) {
                            if (d.Class) {
                                players.push({
                                    player: merge(new SFPlayer(), d),
                                    score: null,
                                    index: iterator++
                                });
                            } else {
                                var player = d.own ? new SFOwnPlayer(d) : new SFOtherPlayer(d);
                                player.Fortress.Gladiator = 0;
                                players.push({
                                    player: merge(new SFPlayer(), player),
                                    score: null,
                                    index: iterator++
                                });
                            }
                        }

                        showPlayers();
                    } else {
                        if (data.Class) {
                            fill(data);
                        } else {
                            var player = data.own ? new SFOwnPlayer(data) : new SFOtherPlayer(data);
                            player.Fortress.Gladiator = 0;

                            fill(player);
                        }
                    }
                } catch (e) {

                }
            });

            var mode = 0;
            $('#sim-mode').change(function () {
                mode = Number($(this).val());

                for (var p of players) {
                    p.score = null;
                }
                yourself = -1;
                clearSort();
            });

            // Run simulation
            $('#sim-run').click(function () {
                if (players.length > 1) {
                    logClear();

                    for (var i = 0; i < players.length; i++) {
                        players[i].score = null;
                    }

                    showPlayers();
                    toggleAll(true);

                    var iterations = Number($('#sim-iterations').val()) || 10000;

                    var blockSize = 5;
                    if (iterations < 500) {
                        blockSize = 25;
                    } else if (iterations < 5000) {
                        blockSize = 10;
                    }

                    var blocks = Math.ceil(players.length / blockSize);
                    var results = [];
                    var ladder = [];

                    if (mode == 2) {
                        logLine(`GENERATING LADDER`);

                        ladder = [ ... players ];
                        new FightSimulator().simulateMultiple(ladder, ladder, 100);

                        ladder.sort((a, b) => a.score.avg - b.score.avg);

                        for (var i = 0; i < ladder.length; i++) {
                            ladder[i].score = null;
                        }
                    }

                    logLine(`BLOCK SIZE: <b>${ blockSize }</b>`);
                    logLine(`ITERATIONS: <b><b>${ iterations }</b>`);

                    logLine(`<b><br/>STARTING ${ blocks } THREADS</b>`);

                    for (var i = 0; i < players.length; i+= blockSize) {
                        var block = players.slice(i, i + blockSize);
                        var worker = new Worker('js/core/simulator.js');

                        worker.addEventListener('message', function (message) {
                            if (message.data.command == 'finished') {
                                results.push(... message.data.results);

                                logLine(`THREAD FINISHED IN <b>${ message.data.time / 1000 }</b> SECONDS`);

                                if (results.length == players.length) {
                                    toggleAll();

                                    players = results;
                                    selected = -1;
                                    setSort('avg', 0);
                                }
                            }
                        }, false);

                        if (mode == 0) {
                            worker.postMessage({
                                mode: 0,
                                player: block,
                                players: players,
                                iterations: iterations
                            });
                        } else if (mode == 1) {
                            worker.postMessage({
                                mode: 1,
                                player: players.find(p => p.index == yourself),
                                players: block,
                                iterations: iterations
                            });
                        } else {
                            worker.postMessage({
                                mode: 2,
                                player: block,
                                players: ladder,
                                iterations: iterations
                            });
                        }
                    }
                }
            });

            var selected = -1;
            var yourself = -1;

            var players = [];
            var iterator = 0;

            $('#sim-save').click(function () {
                if (valid()) {
                    if (selected != -1) {
                        var index = players.findIndex(p => p.index == selected);
                        if (index != -1) {
                            players[index].player = read();
                            players[index].score = null;
                        }

                        showPlayers();
                    } else {
                        $('#sim-add').trigger('click');
                    }
                }
            });

            $('#sim-copy').click(function () {
                copy(read());
            });

            $('#sim-copyall').click(function () {
                copy(players.map(p => p.player));
            });

            function copy (content) {
                const element = document.createElement('textarea');
                element.value = JSON.stringify(content);
                document.body.appendChild(element);
                element.select();
                document.execCommand('copy');
                document.body.removeChild(element);
            }

            $('#sim-add').click(function () {
                if (valid()) {
                    var player = read();
                    if (player.Name == '') {
                        player.Name = `Player ${ players.length + 1 }`;
                    }

                    selected = iterator++;
                    players.push({
                        player: player,
                        score: null,
                        index: selected
                    });

                    clear();

                    showPlayers();
                }
            });

            var sort = '';
            var order = 0;

            $('[data-sort]').click(function () {
                setSort($(this).attr('data-sort'));
            });

            function setSort (key, ord) {
                if (ord == undefined) {
                    if (sort == key) {
                        order = (order + 1) % 2;
                    } else {
                        sort = key;
                        order = 0;
                    }
                } else {
                    sort = key;
                    order = ord;
                }

                showPlayers();
            }

            function clearSort () {
                sort = '';
                order = 0;

                showPlayers();
            }

            function showPlayers () {
                if (order == 0) {
                    if (sort == 'class') {
                        players.sort((a, b) => a.player.Class - b.player.Class);
                    } else if (sort == 'level') {
                        players.sort((a, b) => b.player.Level - a.player.Level);
                    } else if (sort == 'name') {
                        players.sort((a, b) => a.player.Name.localeCompare(b.player.Name));
                    } else if (sort == 'avg') {
                        players.sort((a, b) => b.score && a.score && (b.score.avg - a.score.avg));
                    } else if (sort == 'min') {
                        players.sort((a, b) => b.score && a.score && (b.score.min - a.score.min));
                    } else if (sort == 'max') {
                        players.sort((a, b) => b.score && a.score && (b.score.max - a.score.max));
                    }
                } else {
                    if (sort == 'class') {
                        players.sort((b, a) => a.player.Class - b.player.Class);
                    } else if (sort == 'level') {
                        players.sort((b, a) => b.player.Level - a.player.Level);
                    } else if (sort == 'name') {
                        players.sort((b, a) => a.player.Name.localeCompare(b.player.Name));
                    } else if (sort == 'avg') {
                        players.sort((b, a) => b.score && a.score && (b.score.avg - a.score.avg));
                    } else if (sort == 'min') {
                        players.sort((b, a) => b.score && a.score && (b.score.min - a.score.min));
                    } else if (sort == 'max') {
                        players.sort((b, a) => b.score && a.score && (b.score.max - a.score.max));
                    }
                }

                $('[data-sort]').each(function () {
                    $(this).attr('data-sort-style', $(this).attr('data-sort') == sort ? (order + 1) : 0);
                });

                var content = '';

                if (mode == 1 && yourself == -1) {
                    if (players.length) {
                        yourself = players[0].index;
                    }
                }

                if (mode > 0) {
                    $('[data-sort="min"]').hide();
                    if (mode == 1) {
                        $('[data-sort="max"]').hide();
                    } else {
                        $('[data-sort="max"]').show();
                    }
                } else {
                    $('[data-sort="min"]').show();
                    $('[data-sort="max"]').show();
                }

                if (mode == 2) {
                    $('[data-sort="max"]').text('Ladder');
                } else {
                    $('[data-sort="max"]').text('Max %');
                }

                for (var i = 0; i < players.length; i++) {
                    var player = players[i].player;
                    var score = players[i].score;
                    var index = players[i].index;

                    content += `
                        <div class="row selectable ${ index == selected ? 'selected' : 'nselected' } ${ mode == 1 && index == yourself ? 'btwo' : 'bnone' }" data-index="${ index }">
                            <div class="two wide text-center column">
                                <img class="ui medium centered image" style="width: 50px;" src="res/class${ player.Class }.png">
                            </div>
                            <div class="one wide text-center column">
                                <b>${ player.Level }</b>
                            </div>
                            <div class="one wide column"></div>
                            <div class="four wide column">
                                <b>${ player.Name }</b>
                            </div>
                            <div class="two wide text-center column">
                                ${ score ? (mode == 2 ? `${ score.avg } pt` : `${ score.avg.toFixed(2) }%`) : '' }
                            </div>
                            <div class="two wide text-center column">
                                ${ score && score.min != undefined ? `${ score.min.toFixed(2) }%` : '' }
                            </div>
                            <div class="two wide text-center column">
                                ${ score ? (mode == 2 ? `${ score.max }` : `${ score.max.toFixed(2) }%`) : '' }
                            </div>
                            <div class="one wide text-center column">
                                ${ mode == 1 && index != yourself ? `<i class="user circle icon glow-y" data-index-crown="${ i }"></i>` : ''}
                            </div>
                            <div class="one wide text-center column">
                                <i class="trash right aligned alternate glow outline icon" data-index-trash="${ i }"></i>
                            </div>
                        </div>
                    `;
                }

                $('#sim-players').html(content);

                $('[data-index]').click(function () {
                    selected = Number($(this).attr('data-index'));
                    fill(players.find(p => p.index == selected).player);

                    showPlayers();
                });

                $('[data-index-crown]').click(function () {
                    yourself = players[Number($(this).attr('data-index-crown'))].index;

                    showPlayers();
                });

                $('[data-index-trash]').click(function () {
                    var sel = Number($(this).attr('data-index-trash'));
                    players.splice(sel, 1);

                    var ss = players.findIndex(p => p.index == selected);
                    if (ss == -1) {
                        clear();
                    }

                    selected = ss;

                    var sx = players.findIndex(p => p.index == yourself);
                    if (sx == -1) {
                        yourself = -1;
                    }

                    showPlayers();
                });
            }
        </script>
    </body>
</html>
