<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Simulator</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/html2canvas.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/core/simulator.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">

        <style>
            .bordered .fields:last-of-type {
                margin-bottom: 0;
            }

            .bordered {
                padding: 0.5em;
                margin-bottom: 0.5em;
            }

            .bnone {
                border: 1px solid transparent;
            }

            .bone {
                border: 1px solid orange;
            }

            .btwo {
                border: 1px solid purple;
            }

            .bthree {
                border: 1px solid blue;
            }

            .bfour {
                border: 1px solid red;
            }

            .pet-25 {
                background-color: #99ffb4;
            }

            .pet-10 {
                background-color: #daff99;
            }

            .pet-5 {
                background-color: #fdff99;
            }

            .pet-1 {
                background-color: #ffdd99;
            }

            .pet-0 {
                background-color: #ffad99;
            }

            table.table-map-pet {
                font-size: 90% !important;
            }

            .fixed-header thead tr {
                display: block;
                margin-right: 17px;
            }

            .fixed-header tbody {
                overflow: auto;
                display: block;
                height: 69vh;
                width: 100%;
            }

            #sim-map td {
                width: 5.2em;
            }
        </style>
    </head>
    <body class="margin-none-bottom">
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>

        <div class="ui main container">
            <!-- Header -->
            <div class="ui five columns middle aligned grid">
                <div class="two wide column">
                    <button class="ui small basic icon button" data-position="bottom center" data-tooltip="Save generated table as image" id="sim-screenshot"><i class="download icon"></i></button>
                </div>
                <div class="three wide column">
                    <div class="ui two small buttons">
                        <button class="ui button" type="submit" id="sim-save">Save</button>
                        <button class="ui button" type="submit" id="sim-load">Load</button>
                    </div>
                </div>
                <div class="one wide column">

                </div>
                <div class="four wide column">
                    <h1 class="ui centered header">Pet Simulator</h1>
                </div>
                <div class="two wide column" data-tooltip="Generate a level / gladiator success map. Only possible with own pet against a dungeon boss." data-position="bottom center">
                    <button class="ui fluid small button disabled" type="submit" id="sim-generate">Generate</button>
                </div>
                <div class="two wide column">
                    <button class="ui fluid small button" type="submit" id="sim-run">Run</button>
                </div>
                <div class="two wide wide column" id="sim-result">

                </div>
            </div>
            <div class="ui two columns grid">
                <!-- First -->
                <div class="column">
                    <div class="ui form" id="sim-a">
                        <div class="bordered bone">
                            <div class="three fields">
                                <div class="field">
                                    <label>Type</label>
                                    <div class="ui selection compact dropdown" data-path="Type">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Pet</label>
                                    <div class="ui search selection compact dropdown" data-path="Pet">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Habitat</label>
                                            <div class="ui selection compact dropdown" data-path="Habitat">
                                                <div class="text"></div>
                                                <i class="dropdown icon"></i>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <label>Level</label>
                                            <input class="text-center" data-path="Level">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Pack</label>
                                    <input class="text-center" data-path="Pack">
                                </div>
                                <div class="field">
                                    <label>At 100+</label>
                                    <input class="text-center" data-path="At100">
                                </div>
                                <div class="field">
                                    <label>At 200</label>
                                    <input class="text-center" data-path="At200">
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Gladiator</label>
                                    <div class="ui search selection compact dropdown" data-path="Gladiator">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bordered bthree" data-debug="">
                            <div class="two fields">
                                <div class="field">
                                    <label>Class</label>
                                    <input class="text-center" disabled data-dpath="Class">
                                </div>
                                <div class="field">
                                    <label>Health</label>
                                    <input class="text-center" disabled data-dpath="TotalHealth">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Attribute</label>
                                    <input class="text-center" disabled data-dpath="Attribute">
                                </div>
                                <div class="field">
                                    <label>Defense</label>
                                    <input class="text-center" disabled data-dpath="DefenseAttribute">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Skip Chance</label>
                                    <input class="text-center" disabled data-dpath="SkipChance">
                                </div>
                                <div class="field">
                                    <label>Critical Chance</label>
                                    <input class="text-center" disabled data-dpath="CriticalChance">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Damage</label>
                                    <input class="text-center" disabled data-dpath="Damage">
                                </div>
                                <div class="field">
                                    <label>Critical</label>
                                    <input class="text-center" disabled data-dpath="Critical">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Player list -->
                <div class="column">
                    <div class="ui form" id="sim-b">
                        <div class="bordered btwo">
                            <div class="three fields">
                                <div class="field">
                                    <label>Type</label>
                                    <div class="ui selection compact dropdown" data-path="Type">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Pet</label>
                                    <div class="ui search selection compact dropdown" data-path="Pet">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="two fields">
                                        <div class="field">
                                            <label>Habitat</label>
                                            <div class="ui selection compact dropdown" data-path="Habitat">
                                                <div class="text"></div>
                                                <i class="dropdown icon"></i>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <label>Level</label>
                                            <input class="text-center" data-path="Level">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Pack</label>
                                    <input class="text-center" data-path="Pack">
                                </div>
                                <div class="field">
                                    <label>At 100+</label>
                                    <input class="text-center" data-path="At100">
                                </div>
                                <div class="field">
                                    <label>At 200</label>
                                    <input class="text-center" data-path="At200">
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label>Gladiator</label>
                                    <div class="ui search selection compact dropdown" data-path="Gladiator">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bordered bfour" data-debug="">
                            <div class="two fields">
                                <div class="field">
                                    <label>Class</label>
                                    <input class="text-center" disabled data-dpath="Class">
                                </div>
                                <div class="field">
                                    <label>Health</label>
                                    <input class="text-center" disabled data-dpath="TotalHealth">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Attribute</label>
                                    <input class="text-center" disabled data-dpath="Attribute">
                                </div>
                                <div class="field">
                                    <label>Defense</label>
                                    <input class="text-center" disabled data-dpath="DefenseAttribute">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Skip Chance</label>
                                    <input class="text-center" disabled data-dpath="SkipChance">
                                </div>
                                <div class="field">
                                    <label>Critical Chance</label>
                                    <input class="text-center" disabled data-dpath="CriticalChance">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Damage</label>
                                    <input class="text-center" disabled data-dpath="Damage">
                                </div>
                                <div class="field">
                                    <label>Critical</label>
                                    <input class="text-center" disabled data-dpath="Critical">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <table id="sim-map" class="ui celled structured table table-group table-map-pet fixed-header"></table>
        </div>

        <script type="text/javascript">
            function validateBulk ($parent) {
                return $parent.find('[data-path]').toArray().reduce((errors, element) => {
                    if (isNaN($(element).val())) {
                        $(element).parent('.field').addClass('error');
                        return errors + 1;
                    } else {
                        $(element).parent('.field').removeClass('error');
                        return errors;
                    }
                }, 0) == 0;
            }

            function validate ($element) {
                if (isNaN($element.val())) {
                    $element.parent('.field').addClass('error');
                    return false;
                } else {
                    $element.parent('.field').removeClass('error');
                    return true;
                }
            }

            function freeze () {
                $('.ui.main.container').toggleClass('frozen');
            }

            class PetController {
                constructor ($root, index) {
                    this.$root = $root;

                    // Variables
                    this.Gladiator = 0;
                    this.Pet = 0;
                    this.Type = 0;
                    this.Boss = 0;
                    this.Level = 0;
                    this.Pack = 0;
                    this.At100 = 0;
                    this.At200 = 0;
                    this.Index = index;

                    // Elements
                    this.$level = $root.find('[data-path="Level"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.Level = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    this.$pack = $root.find('[data-path="Pack"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.Pack = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    this.$at100 = $root.find('[data-path="At100"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.At100 = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    this.$at200 = $root.find('[data-path="At200"]').val('').on('input', event => {
                        var $e = $(event.currentTarget);
                        this.At200 = validate($e) ? Number($e.val()) : 0;

                        this.refresh();
                    });

                    // Gladiator
                    this.$gladiator = $root.find('[data-path="Gladiator"]').dropdown({
                        values: [
                            { name: 'None', value: 0 },
                            ... [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ].map(gladiator => {
                                return {
                                    name: `${ gladiator } (${ gladiator * 5 }%)`,
                                    value: gladiator
                                }
                            })
                        ]
                    }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                        this.Gladiator = Number(value);

                        this.refresh();
                    });

                    // Habitat
                    this.$habitat = $root.find('[data-path="Habitat"]').dropdown({
                        values: [
                            { name: 'No', value: 0 },
                            { name: 'Yes', value: 1 }
                        ]
                    }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                        this.setHabitat(Number(value));

                        this.refresh();
                    });

                    // Pets
                    this.$pet = $root.find('[data-path="Pet"]').dropdown({
                        fullTextSearch: true,
                        values: new Array(100).fill(0).map((_ , i) => {
                            return {
                                name: `${ (i % 20) + 1 } ${ NAME_MONSTER[800 + i] }`,
                                value: i
                            };
                        })
                    }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                        this.Pet = Number(value) % 20;
                        this.refresh();
                    });

                    // Types
                    this.$type = $root.find('[data-path="Type"]').dropdown({
                        values: [
                            { name: 'Shadow', value: 0 },
                            { name: 'Light', value: 1 },
                            { name: 'Earth', value: 2 },
                            { name: 'Fire', value: 3 },
                            { name: 'Water', value: 4 }
                        ]
                    }).dropdown('setting', 'onChange', (value, text) => {
                        this.setType(Number(value));

                        this.refresh();
                    }).dropdown('set selected', '0');
                }

                setType (type) {
                    this.Type = type;
                    this.Pet = 0;

                    this.$pet.dropdown('set selected', (this.Type * 20).toString());
                    this.$pet.find('.item').each((i, e) => {
                        var $e = $(e);
                        var id = Number($e.attr('data-value'));

                        if (Math.trunc(id / 20) == type) {
                            $e.removeClass('hidden');
                        } else {
                            $e.addClass('hidden');
                        }
                    });
                }

                setHabitat (habitat) {
                    this.Boss = habitat;

                    if (habitat) {
                        this.$level.parent('.field').addClass('disabled');
                        this.$pack.parent('.field').addClass('disabled');
                        this.$at100.parent('.field').addClass('disabled');
                        this.$at200.parent('.field').addClass('disabled');
                        this.$gladiator.parent('.field').addClass('disabled');
                    } else {
                        this.$level.parent('.field').removeClass('disabled');
                        this.$pack.parent('.field').removeClass('disabled');
                        this.$at100.parent('.field').removeClass('disabled');
                        this.$at200.parent('.field').removeClass('disabled');
                        this.$gladiator.parent('.field').removeClass('disabled');
                    }
                }

                refresh () {
                    if (validateBulk(this.$root)) {
                        if (this.Level > 0 || this.Boss) {
                            models[this.Index] = PetModel.fromObject(this);
                            this.$root.find('[data-debug]').show();
                        } else {
                            models[this.Index] = undefined;
                            this.$root.find('[data-debug]').hide();
                        }
                    } else {
                        models[this.Index] = undefined;
                        this.$root.find('[data-debug]').hide();
                    }

                    refreshModels();
                }

                fillDebugInformation (model, initialized) {
                    this.$root.find('[data-dpath="Class"]').val(PLAYER_CLASS[model.Class]);
                    this.$root.find('[data-dpath="TotalHealth"]').val(formatAsSpacedNumber(model.TotalHealth, ' '));
                    this.$root.find('[data-dpath="Attribute"]').val(formatAsSpacedNumber(model.Attribute, ' '));
                    this.$root.find('[data-dpath="DefenseAttribute"]').val(formatAsSpacedNumber(model.DefenseAttribute, ' '));

                    if (initialized) {
                        this.$root.find('[data-dpath="SkipChance"]').val(model.SkipChance > 0 ? `${ model.SkipChance.toFixed(2) }%` : 'None');
                        this.$root.find('[data-dpath="Damage"]').val(formatAsSpacedNumber(model.Damage, ' '));
                        this.$root.find('[data-dpath="CriticalChance"]').val(model.CriticalChance > 0 ? `${ model.CriticalChance.toFixed(2) }%` : 'None');
                        this.$root.find('[data-dpath="Critical"]').val(`${ Math.round(100 * model.Critical) }%`);
                    } else {
                        this.$root.find('[data-dpath="SkipChance"], [data-dpath="CriticalChance"], [data-dpath="Damage"], [data-dpath="Critical"]').val('?');
                    }
                }

                getData () {
                    return {
                        Gladiator: this.Gladiator,
                        Pet: this.Pet,
                        Type: this.Type,
                        Boss: this.Boss,
                        Level: this.Level,
                        Pack: this.Pack,
                        At100: this.At100,
                        At200: this.At200,
                        Index: this.Index
                    };
                }

                loadData (data) {
                    this.$at100.val(data.At100).trigger('input');
                    this.$at200.val(data.At200).trigger('input');
                    this.$pack.val(data.Pack).trigger('input');
                    this.$level.val(data.Level).trigger('input');

                    this.$gladiator.dropdown('set selected', data.Gladiator.toString());
                    this.$type.dropdown('set selected', data.Type.toString());
                    this.$pet.dropdown('set selected', (data.Type * 20 + data.Pet).toString());
                    this.$habitat.dropdown('set selected', data.Boss.toString());
                }
            };

            function refreshModels () {
                var [a, b] = models;
                var ab = false;

                if (a && b) {
                    a.initialize(b);
                    b.initialize(a);

                    ab = true;

                    petA.fillDebugInformation(a, true);
                    petB.fillDebugInformation(b, true);
                } else if (a) {
                    petA.fillDebugInformation(a, false);
                } else if (b) {
                    petB.fillDebugInformation(b, false);
                }

                if (petA && petB && petA.Boss == 0 && petB.Boss == 1) {
                    $('#sim-generate').removeClass('disabled');
                } else {
                    $('#sim-generate').addClass('disabled');
                }
            }

            var curr = '';
            var models = [ undefined, undefined ];

            var petA = new PetController($('#sim-a'), 0);
            var petB = new PetController($('#sim-b'), 1);

            $('#sim-save').click(() => {
                localStorage['pets/0'] = JSON.stringify([
                    petA.getData(),
                    petB.getData()
                ]);
            });

            $('#sim-load').click(() => {
                if (localStorage['pets/0']) {
                    var [ a, b ] = JSON.parse(localStorage['pets/0']);
                    petA.loadData(a);
                    petB.loadData(b);
                }
            });

            $('#sim-run').click(function () {
                if (validateBulk(petA.$root) && validateBulk(petB.$root)) {
                    var a = petA.getData();
                    var b = petB.getData();

                    if (a && b && (a.Level > 0 || a.Boss) && (b.Level > 0 || b.Boss)) {
                        freeze();

                        var worker = new Worker('js/core/simulator.js');

                        worker.addEventListener('message', function (message) {
                            if (message.data.command == 'finished') {
                                var chance = message.data.results;
                                if (chance < 0.01) {
                                    $('#sim-result').html(message.data.results.toFixed(5) + '%');
                                } else {
                                    $('#sim-result').html(message.data.results.toFixed(2) + '%');
                                }

                                freeze();
                            }
                        }, false);

                        worker.postMessage({
                            mode: 999,
                            players: [a, b]
                        });
                    }
                }
            });

            function getPetColor (num) {
                if (num < 0.01) {
                    return 'pet-0';
                } else if (num >= 25) {
                    return 'pet-25'
                } else if (num >= 10) {
                    return 'pet-10';
                } else if (num >= 5) {
                    return 'pet-5';
                } else {
                    return 'pet-1';
                }
            }

            $('#sim-generate').click(function () {
                if (validateBulk(petA.$root) && validateBulk(petB.$root)) {
                    $('#sim-map').html('');
                    $('#sim-result').html('');

                    var a = petA.getData();
                    var b = petB.getData();

                    if (a && b && !a.Boss && b.Boss) {
                        freeze();

                        var worker = new Worker('js/core/simulator.js');

                        worker.addEventListener('message', function (message) {
                            if (message.data.command == 'finished') {
                                var map = message.data.results;

                                $('#sim-map').html(`
                                    <thead>
                                        <tr>
                                            ${ new Array(16).fill(0).reduce((col, a, i) => col + `<td>Glad ${ i }</td>`, '<td>Level</td>') }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ map.reduce((col, a, i) => col + `<tr><td>${ i + 1 }</td>${ a.reduce((c, w) => c + `<td class="${ getPetColor(w) }">${ w.toFixed(2) }%</td>`, '') }</tr>`, '') }
                                    </tbody>
                                `);

                                curr = `${ NAME_MONSTER[800 + petA.Type * 20 + petA.Pet] } (${ petA.Pack }, ${ petA.At100 }, ${ petA.At200 }) vs ${ NAME_MONSTER[800 + petB.Type * 20 + petB.Pet] }`;

                                freeze();
                            }
                        }, false);

                        worker.postMessage({
                            mode: 1000,
                            players: [a, b]
                        });
                    }
                }
            });

            $('#sim-screenshot').click(() => {
                if (curr) {
                    html2canvas($('#sim-map').get(0), {
                        logging: false,
                        onclone: (doc) => {
                            $(doc).find('#sim-map').removeClass('fixed-header').find('thead').prepend($(`<tr><td colspan="17" class="text-center"><b>${ curr }</b></td></tr>`));
                        }
                    }).then((canvas) => {
                        canvas.toBlob((blob) => {
                            window.download(`${ curr || 'unknown' }.png`, blob);
                        });
                    });
                }
            });
        </script>
    </body>
</html>
