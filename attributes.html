<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Gold & Experience</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/changelog.js"></script>
        <script src="js/views.js"></script>
        <script src="js/core/ui.js"></script>

        <style>
            .orange {
                color: orange;
            }

            .green {
                color: darkgreen;
            }

            .blue {
                color: blue;
            }

            .purple {
                color: purple;
            }
        </style>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item"><a class="css-a-blank" href="index.html">SFTools</a></div>
            <a class="item" id="show-attributes">Gold & Experience</a>
            <a class="item" id="show-fortress">Fortress</a>
            <a class="item" id="show-underworld">Underworld</a>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>

        <div class="ui main container" id="tab-gold-experience">
            <div class="ui grid">
                <div class="sixteen wide column">
                    <div class="ui segment">
                        <h3 class="ui header">Gold</h3>
                        <div class="ui small form">
                            <div class="six fields">
                                <div class="field">
                                    <label>Level</label>
                                    <input type="text" id="gold-level">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Guild bonus %</label>
                                    <input type="text" id="gold-guild">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Tower bonus %</label>
                                    <input type="text" id="gold-tower">
                                </div>
                                <div class="field">
                                    <label><span class="purple">&bull;</span> Gem Mine</label>
                                    <input type="text" id="gold-mine">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Gold Pit</label>
                                    <input type="text" id="gold-pit">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Item Quality Rune</label>
                                    <input type="text" id="gold-runes">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label>Environmental reward</label>
                                    <input type="text" disabled id="gold-reward">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Hourly guard duty</label>
                                    <input type="text" disabled id="gold-guard">
                                </div>
                                <div class="field">
                                    <label>Dice game (3 of a kind)</label>
                                    <input type="text" disabled id="gold-dice">
                                </div>
                                <div class="field">
                                    <label><span class="purple">&bull;</span> Small gem</label>
                                    <input type="text" disabled id="gold-gem">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Gold Pit capacity</label>
                                    <input type="text" disabled id="gold-capacity">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> 10% Potion</label>
                                    <input type="text" disabled id="gold-pot10">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label>Witch Scroll</label>
                                    <input type="text" disabled id="gold-scroll">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Quicksand Hourglass</label>
                                    <input type="text" disabled id="gold-hourglass1">
                                </div>
                                <div class="field">
                                    <label>Dice game (4 of a kind)</label>
                                    <input type="text" disabled id="gold-dice2">
                                </div>
                                <div class="field">
                                    <label><span class="purple">&bull;</span> Medium gem</label>
                                    <input type="text" disabled id="gold-gem2">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Hourly Gold Pit</label>
                                    <input type="text" disabled id="gold-hourly">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> 15% Potion</label>
                                    <input type="text" disabled id="gold-pot15">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label>Calendar 1 bar</label>
                                    <input type="text" disabled id="gold-bar">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> 10 Quicksand Hourglasses</label>
                                    <input type="text" disabled id="gold-hourglass10">
                                </div>
                                <div class="field">
                                    <label>Dice game (5 of a kind)</label>
                                    <input type="text" disabled id="gold-dice3">
                                </div>
                                <div class="field">
                                    <label><span class="purple">&bull;</span> Large gem</label>
                                    <input type="text" disabled id="gold-gem3">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Gold Pit time</label>
                                    <input type="text" disabled id="gold-time">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> 25% Potion</label>
                                    <input type="text" disabled id="gold-pot25">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label>Calendar 3 bars / Locked</label>
                                    <input type="text" disabled id="gold-bar3">
                                </div>
                                <div class="field">
                                    <label>Witch Potion</label>
                                    <input type="text" disabled id="gold-witchpot">
                                </div>
                                <div class="field">

                                </div>
                                <div class="field">

                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Real Hourly Gold Pit</label>
                                    <input type="text" disabled id="gold-hourly-real">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Mushroom PoEL</label>
                                    <input type="text" disabled id="gold-pothp">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label>Arena Max</label>
                                    <input type="text" disabled id="gold-arena">
                                </div>
                                <div class="field">
                                    <label>Fortress Reroll</label>
                                    <input type="text" disabled id="gold-reroll">
                                </div>
                                <div class="field">
                                    <label>Tower (Level is enemy level)</label>
                                    <input type="text" disabled id="gold-towerboss">
                                </div>
                                <div class="field">
                                    <label>Twister (Level is enemy level)</label>
                                    <input type="text" disabled id="gold-twisterboss">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Real Gold Pit time</label>
                                    <input type="text" disabled id="gold-time-real">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Gold PoEL</label>
                                    <input type="text" disabled id="gold-pothp-gold">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui segment">
                        <h3 class="ui header">Experience</h3>
                        <div class="ui small form">
                            <div class="six fields">
                                <div class="field">
                                    <label>Level</label>
                                    <input type="text" id="xp-level">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Hydra heads</label>
                                    <input type="text" id="xp-hydra">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Academy</label>
                                    <input type="text" id="xp-academy">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label>Next Level</label>
                                    <input type="text" disabled id="xp-next">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Daily mission</label>
                                    <input type="text" disabled id="xp-daily">
                                </div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Hourly Academy</label>
                                    <input type="text" disabled id="xp-hourly">
                                </div>
                                <div class="field">
                                    <label>Calendar 1 book</label>
                                    <input type="text" disabled id="xp-calendar1">
                                </div>
                                <div class="field">
                                    <label>Arena</label>
                                    <input type="text" disabled id="xp-arena">
                                </div>
                                <div class="field">
                                    <label>Dungeon (Level is enemy level)</label>
                                    <input type="text" disabled id="xp-dungeon">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field"></div>
                                <div class="field"></div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Academy time</label>
                                    <input type="text" disabled id="xp-time">
                                </div>
                                <div class="field">
                                    <label>Calendar 2 books</label>
                                    <input type="text" disabled id="xp-calendar2">
                                </div>
                                <div class="field">
                                    <label>Wheel book</label>
                                    <input type="text" disabled id="xp-wheel1">
                                </div>
                                <div class="field">
                                    <label>Twister (Level is enemy level)</label>
                                    <input type="text" disabled id="xp-twister">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field"></div>
                                <div class="field"></div>
                                <div class="field">
                                    <label><span class="orange">&bull;</span> Academy capacity</label>
                                    <input type="text" disabled id="xp-capacity">
                                </div>
                                <div class="field">
                                    <label>Calendar 3 books</label>
                                    <input type="text" disabled id="xp-calendar3">
                                </div>
                                <div class="field">
                                    <label>Wheel books</label>
                                    <input type="text" disabled id="xp-wheel2">
                                </div>
                                <div class="field">
                                    <label>Habitat Boss</label>
                                    <input type="text" disabled id="xp-habitat">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui segment">
                        <h3 class="ui header">Quests (Experimental)</h3>
                        <div class="ui small form">
                            <div class="six fields">
                                <div class="field">
                                    <label>Level</label>
                                    <input type="text" id="quest-level">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Scrapbook %</label>
                                    <input type="text" id="quest-book">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Guild XP %</label>
                                    <input type="text" id="quest-xp">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Experience Rune</label>
                                    <input type="text" id="quest-rxp">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Minimum XP</label>
                                    <input type="text" disabled id="quest-xpmin">
                                </div>
                                <div class="field">
                                    <label><span class="green">&bull;</span> Maximum XP</label>
                                    <input type="text" disabled id="quest-xpmax">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field"></div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Tower</label>
                                    <input type="text" id="quest-tower">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Guild Gold %</label>
                                    <input type="text" id="quest-gold">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Gold Rune</label>
                                    <input type="text" id="quest-rgold">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Minimum Gold</label>
                                    <input type="text" disabled id="quest-goldmin">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Maximum Gold</label>
                                    <input type="text" disabled id="quest-goldmax">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui segment">
                        <h3 class="ui header">Miscellaneous</h3>
                        <div class="ui small form">
                            <div class="six fields">
                                <div class="field">
                                    <label>Level</label>
                                    <input type="text" id="misc-level">
                                </div>
                                <div class="field">
                                    <label><span class="blue">&bull;</span> Underworld Gate</label>
                                    <input type="text" id="misc-gate">
                                </div>
                                <div class="field">
                                    <label><span class="purple">&bull;</span> Torture Chamber</label>
                                    <input type="text" id="misc-torture">
                                </div>
                            </div>
                            <div class="six fields">
                                <div class="field">
                                    <label><span class="blue">&bull;</span><span class="purple">&bull;</span> Souls (Level is enemy level)</label>
                                    <input type="text" disabled id="misc-souls">
                                </div>
                            </div>
                        </div>
                    </div>
                    <br/>
                    <div class="ui segment">
                        <h3 class="ui header">Calculate price at</h3>
                        <div class="ui small form">
                            <div class="two fields">
                                <div class="field">
                                    <label>Attribute</label>
                                    <input type="text" id="priceat-attribute" val="0">
                                </div>
                                <div class="field">
                                    <label>Cost</label>
                                    <input type="text" disabled id="priceat-price">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui segment">
                        <h3 class="ui header">Calculate price between</h3>
                        <div class="ui small form">
                            <div class="three fields">
                                <div class="field">
                                    <label>From</label>
                                    <input type="text" id="pricebetween-from">
                                </div>
                                <div class="field">
                                    <label>To</label>
                                    <input type="text" id="pricebetween-to">
                                </div>
                                <div class="field">
                                    <label>Cost</label>
                                    <input type="text" disabled id="pricebetween-price">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sixteen wide column">
                    <button class="ui right floated button small" id="copy-table-col" style="margin-bottom: 0.5em; margin-top: -1em; margin-left: 1em;">Copy table (comma)</button>
                    <button class="ui right floated button small" id="copy-table" style="margin-bottom: 0.5em; margin-top: -1em;">Copy table</button>
                    <table class="ui celled structured table table-group" id="data-table">
                        <thead>
                            <tr>
                                <td width="150">Attribute / Level</td>
                                <td width="150">Attribute Price</td>
                                <td width="150">Gold Curve</td>
                                <td width="150">Griffin</td>
                                <td width="150">Guard Duty / Dice (3)</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="border-bottom-thick"></td>
                            </tr>
                        </thead>
                        <tbody id="attribute-prices" class="opaque-rows" style="text-align: center;">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="ui main container" id="tab-fortress">
            Under construction :)
        </div>

        <div class="ui main container" id="tab-underworld">
            <div class="ui segment">
                <h3 class="ui header">Character values</h3>
                <div class="ui small form">
                    <div class="fix fields">
                        <div class="field">
                            <label>Labourer's Quarters</label>
                            <input type="text" id="fortress-lq">
                        </div>
                    </div>
                </div>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Heart of Darkness</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 45%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-heart"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Underworld Gate</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 10%;">Lures</th>
                            <th style="width: 10%;">Lure Bonus</th>
                            <th style="width: 25%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-gate"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Gold Pit</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 35%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-goldpit"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Soul Extractor</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 15%;">Hourly</th>
                            <th style="width: 15%;">Capacity</th>
                            <th style="width: 15%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-extractor"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Goblin Pit</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 15%;">Goblins</th>
                            <th style="width: 30%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-goblinpit"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Torture Chamber</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 15%;">Lure Bonus</th>
                            <th style="width: 30%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-torture"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Gladiator Trainer</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 15%;">Critical Bonus</th>
                            <th style="width: 30%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-gladiator"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Troll Block</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 15%;">Trolls</th>
                            <th style="width: 30%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-trolls"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Time Machine</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 15%;">Free Thirst</th>
                            <th style="width: 15%;">Useable Thirst</th>
                            <th style="width: 15%;">Capacity</th>
                        </tr>
                    </thead>
                    <tbody id="underworld-timemachine"></tbody>
                </table>
            </div>
            <div class="ui segment">
                <h3 class="ui header">Keeper</h3>
                <table class="ui red single very compact line table text-center">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Level</th>
                            <th style="width: 15%;">Build Time</th>
                            <th style="width: 15%;">Gold</th>
                            <th style="width: 15%;">Souls</th>
                            <th style="width: 35%;"></th>
                        </tr>
                    </thead>
                    <tbody id="underworld-keeper"></tbody>
                </table>
            </div>
        </div>

        <script type="text/javascript">
            UI.init({
                GoldExperience: new View('tab-gold-experience'),
                Fortress: new View('tab-fortress'),
                Underworld: new View('tab-underworld')
            });
            UI.register(UI.GoldExperience, 'show-attributes');
            UI.register(UI.Fortress, 'show-fortress');
            UI.register(UI.Underworld, 'show-underworld');
            UI.show(UI.GoldExperience);

            $('#fortress-lq').on('change input', function () {
                if (validate($('#fortress-lq'))) {
                    let lq = getValue('#fortress-lq', 0, 15);

                    const TICKS_PER_HOUR = 60 * 60 * 1000;

                    $('[data-lq]').each((_, el) => {
                        let duration = buildTime(parseInt(el.dataset.lq), lq);
                        el.innerText = formatFancyTime(duration);
                    });
                }
            });

            function generateTable (table, rows, generators, extra_rows) {
                let content = '';
                for (let [index, data] of Object.entries(rows)) {
                    let level = parseInt(index) + 1;

                    let generatedContent = '';
                    if (Array.isArray(data)) {
                        for (let g of generators) generatedContent += `<td>${g(level, ...data)}</td>`
                    } else {
                        for (let g of generators) generatedContent += `<td>${g(level, data)}</td>`
                    }

                    content += `<tr>
                        <td>${level}</td>
                        <td data-lq="${level}"></td>
                        ${generatedContent}
                    </tr>`;
                }
                if (extra_rows) {
                    content += extra_rows;
                }
                $(`#${table}`).html(content);
            }

            (function () {
                const HEART = [
                    0, 616, 1650, 4220, 11000, 25080, 45930, 84150, 198000, 439550, 902850, 2043300, 4118400, 7722000, 16632000
                ];
                generateTable('underworld-heart', HEART, [
                    (level, souls) => level == 1 ? 0 : formatAsSpacedNumber(level * 1000),
                    (level, souls) => formatAsSpacedNumber(souls),
                    () => '<td></td>'
                ]);

                const GATE = [
                    0, 55, 149, 380, 990, 2255, 4820, 10090, 26730, 65930, 135400, 306500, 617750, 1158300, 2494800
                ];
                generateTable('underworld-gate', GATE, [
                    (level, souls) => formatAsSpacedNumber(level * 500),
                    (level, souls) => formatAsSpacedNumber(souls),
                    (level, souls) => Math.min(5, level),
                    (level, souls) => `${100 + Math.max(0, (level - 5) * 20)} %`,
                    () => '<td></td>'
                ]);

                const GOLD_PIT = [
                    12, 46, 124, 317, 825, 1880, 4015, 8415, 19800, 43950, 90280, 204300, 411800, 772200, 1663200, 162518400
                ];
                generateTable('underworld-goldpit', GOLD_PIT, [
                    (level, souls) => formatAsSpacedNumber(level > 15 ? 10E6 : (level * 1000)),
                    (level, souls) => formatAsSpacedNumber(souls),
                    () => '<td></td>'
                ], `
                    <tr><td>...</td><td>...</td><td>...</td><td>...</td><td></td></tr>
                    <tr><td>100</td><td data-lq="100"></td><td>10 000 000</td><td>162 518 400</td><td></td></tr>
                `);

                const EXTRACTOR = [
                    [0, 165, 412], [462, 231, 635], [1235, 330, 990], [3165, 528, 1716], [8250, 825, 2887],
                    [18810, 1254, 4702], [40190, 1914, 7656], [84150, 2805, 14025], [198000, 4125, 24750], [439550, 6105, 48840],
                    [902850, 9405, 94050], [2043300, 14190, 170280], [4118400, 21450, 343200], [7722000, 32175, 643500], [16632000, 49500, 1188000]
                ];
                generateTable('underworld-extractor', EXTRACTOR, [
                    (level, souls, hourly, storage) => formatAsSpacedNumber(level * 250),
                    (level, souls, hourly, storage) => formatAsSpacedNumber(souls),
                    (level, souls, hourly, storage) => formatAsSpacedNumber(hourly),
                    (level, souls, hourly, storage) => formatAsSpacedNumber(storage),
                    () => '<td></td>'
                ]);

                const GOBLIN_PIT = [
                    [0, 1], [396, 2], [1060, 3], [2715, 4], [7070, 5],
                    [16120, 5], [34450, 5], [63110, 5], [148500, 5], [329650, 5],
                    [677150, 5], [1532500, 5], [3088800, 5], [5791500, 5], [12474000, 5]
                ]
                generateTable('underworld-goblinpit', GOBLIN_PIT, [
                    (level, souls, goblins) => formatAsSpacedNumber(level * 400),
                    (level, souls, goblins) => formatAsSpacedNumber(souls),
                    (level, souls, goblins) => goblins,
                    () => '<td></td>'
                ]);

                const TROLL_BLOCK = [
                    [165, 1], [616, 1], [1650, 1], [4220, 1], [11000, 1],
                    [25080, 1], [45930, 1], [84150, 1], [198000, 2], [439550, 2],
                    [902850, 2], [2043300, 2], [4118400, 3], [7722000, 3], [16632000, 4]
                ];
                generateTable('underworld-trolls', TROLL_BLOCK, [
                    (level, souls, trolls) => formatAsSpacedNumber(level * 990),
                    (level, souls, trolls) => formatAsSpacedNumber(souls),
                    (level, souls, trolls) => trolls,
                    () => '<td></td>'
                ]);

                const TORTURE_CHAMBER = [
                    148, 554, 1485, 3800, 9900, 22570, 41340, 75730, 178200, 395600, 812550, 1839000, 3706500, 6949800, 14968500
                ];
                generateTable('underworld-torture', TORTURE_CHAMBER, [
                    (level, souls) => formatAsSpacedNumber(level * 660),
                    (level, souls) => formatAsSpacedNumber(souls),
                    (level, souls) => `${100 + (level * 10)} %`,
                    () => '<td></td>'
                ]);

                const KEEPER = [
                    198, 739, 1980, 5065, 13200, 25080, 45930, 84150, 198000, 439550, 902850, 2043300, 4118400, 7722000, 16632000
                ];
                generateTable('underworld-keeper', KEEPER, [
                    (level, souls) => formatAsSpacedNumber(level * 1500),
                    (level, souls) => formatAsSpacedNumber(souls),
                    () => '<td></td>'
                ]);

                const GLADIATOR_TRAINER = [
                    148, 554, 1485, 3800, 9900, 22570, 48230, 100950, 237600, 527450, 1083400, 2452000, 4942000, 9266400, 19958000
                ];
                generateTable('underworld-gladiator', GLADIATOR_TRAINER, [
                    (level, souls) => formatAsSpacedNumber(level * 700),
                    (level, souls) => formatAsSpacedNumber(souls),
                    (level, souls) => `${100 + (level * 5)} %`,
                    () => '<td></td>'
                ]);

                const TIME_MACHINE = [
                    297, 1105, 2970, 5700, 11880, 22570, 41340, 75730, 178200, 395600, 812550, 1839000, 3706500, 6949800, 14968500
                ];
                generateTable('underworld-timemachine', TIME_MACHINE, [
                    (level, souls) => formatAsSpacedNumber(level * 10000),
                    (level, souls) => formatAsSpacedNumber(souls),
                    (level, souls) => level > 10 ? (10 + (level - 10) * 2) : level,
                    (level, souls) => 4 * (level > 10 ? (10 + (level - 10) * 2) : level),
                    (level, souls) => 100 * (level > 10 ? (10 + (level - 10) * 2) : level)
                ]);
            })();

            $('#underworld-heart').html();

            function formatFancyTime (duration) {
                let days = Math.trunc(duration / (1000 * 60 * 60 * 24));
                let hours = Math.trunc((duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let minutes = Math.trunc((duration % (1000 * 60 * 60)) / (1000 * 60));
                let seconds = Math.trunc((duration % (1000 * 60)) / 1000);

                let str = [];
                if (days > 0) str.push(`${days}d`);
                if (hours > 0) str.push(`${hours}h`);
                if (minutes > 0) str.push(`${minutes}m`);
                if (seconds > 0) str.push(`${seconds}s`);

                return str.slice(0, 2).join(' ');
            }

            $('#fortress-lq').trigger('input');

            function validate (... elements) {
                return elements.reduce((errors, element) => {
                    if (isNaN($(element).val()) || $(element).val() < 0) {
                        $(element).parent('.field').addClass('error');
                        return errors + 1;
                    } else {
                        $(element).parent('.field').removeClass('error');
                        return errors;
                    }
                }, 0) == 0;
            }

            function roundShort(value) {
                return Math.ceil(value * 100) / 100;
            }

            function formatValue(value, delimiter = ' ') {
                return value >= 999 ? formatAsSpacedNumber(value, delimiter) : roundShort(value)
            }

            function formatTime(time) {
                return Math.trunc(time) + ' hours ' + Math.trunc(60 * (time % 1)) + ' minutes';
            }

            function getExperienceRequired (value) {
                if (value >= 393) {
                    return 1500000000;
                } else {
                    return ExperienceRequired[value];
                }
            }

            function getMineMultiplier(m) {
                if (m <= 1) {
                    return 1;
                } else if (m >= 14) {
                    return 24;
                } else switch (m) {
                    case 2: return 2;
                    case 3: return 3;
                    case 4: return 4;
                    case 5: return 6;
                    case 6: return 8;
                    case 7: return 10;
                    case 8: return 12;
                    case 9: return 14;
                    case 10: return 16;
                    case 11: return 18;
                    case 12: return 20;
                    case 13: return 22;
                }
            }

            function getArenaMultiplier (level) {
                if (level >= 300) {
                    return 10;
                } else if (level >= 250) {
                    return 15;
                } else if (level >= 200) {
                    return 20;
                } else if (level >= 150) {
                    return 24;
                } else {
                    return 28;
                }
            }

            function getAcademyMultiplier(m) {
                if (m <= 1) {
                    return 1;
                } else if (m >= 20) {
                    return 12;
                } else switch (m) {
                    case 2: return 1.1;
                    case 3: return 1.2;
                    case 4: return 1.3;
                    case 5: return 1.4;
                    case 6: return 1.5;
                    case 7: return 1.6;
                    case 8: return 2.0;
                    case 9: return 2.4;
                    case 10: return 3.2;
                    case 11: return 4.0;
                    case 12: return 4.8;
                    case 13: return 6.4;
                    case 14: return 8.0;
                    case 15: return 9.6;
                    case 16: return 10.0;
                    case 17: return 10.4;
                    case 18: return 10.8;
                    case 19: return 11.2;
                }
            }

            const UnderworldBuildings = {
                Heart: 0,
                UnderworldGate: 1,
                GoldPit: 2,
                Extractor: 3,
                GoblinPit: 4,
                TortureChamber: 5,
                GladiatorTower: 6,
                TrollBlock: 7,
                TimeMachine: 8,
                Kepper: 9
            }

            const FortressBuildings = {
                Fortress: 0,
                LaborersQuarters: 1,
                WoodcutterHut: 2,
                Quarry: 3,
                GemMine: 4,
                Academy: 5,
                ArcheryGuild: 6,
                Barracks: 7,
                MagesTower: 8,
                Treasury: 9,
                Smithy: 10,
                Fortifications: 11
            }

            // Heart of Darkness
            // Underworld Gate
            // Gold Pit
            // Soul Extractor
            // Goblin Pit
            // Torture Chamber
            // Gladiator Tower
            // Troll Block
            // Time Machine
            // Keeper
            function underworldGold (level, building) {
                const mult = [1, 0.5, 1, 0.25, 0.4, 0.66, 0.7, 0.99, 10, 1.5];
                if (level > 15) {
                    return 10E6;
                } else {
                    return Math.trunc(level * mult[building] * 1E3);
                }
            }

            function underworldSouls (level, building) {
                if (level > 15) {
                    return 162518400;
                } else {
                    return _dig([
                        [0, 616, 1650, 4220, 11000, 25080, 45930, 84150, 198000, 439550, 902850, 2043300, 4118400, 7722000, 16632000],
                        [0, 55, 149, 380, 990, 2255, 4820, 10090, 26730, 65930, 135400, 306500, 617750, 1158300, 2494800],
                        [12, 46, 124, 317, 825, 1880, 4015, 8415, 19800, 43950, 90280, 204300, 411800, 772200, 16632000],
                        [0, 462, 1235, 3165, 8250, 18810, 40190, 84150, 198000, 439550, 902850, 2043300, 4118400, 7722000, 16632000],
                        [0, 396, 1060, 2715, 7070, 16120, 34450, 63110, 148500, 329650, 677150, 1532500, 3088800, 5791500, 12474000],
                        [148, 554, 1485, 3800, 9900, 22570, 41340, 75730, 178200, 395600, 812550, 1839000, 3706500, 6949800, 14968500],
                        [148, 554, 1485, 3800, 9900, 22570, 48230, 100950, 237600, 527450, 1083400, 2452000, 4942000, 9266400, 19958000],
                        [165, 616, 1650, 4220, 11000, 25080, 45930, 84150, 198000, 439550, 902850, 2043300, 4118400, 7722000, 16632000],
                        [297, 1105, 2970, 5700, 11880, 22570, 41340, 75730, 178200, 395600, 812550, 1839000, 3706500, 6949800, 14968500],
                        [198, 739, 1980, 5065, 13200, 25080, 45930, 84150, 198000, 439550, 902850, 2043300, 4118400, 7722000, 16632000]
                    ], building, level - 1);
                }
            }

            function buildTime (level, lq) {
                let mult = 1 - 0.05 * lq;
                if (level > 15) {
                    return 5184000000 * mult;
                } else {
                    return [
                        900, 1895, 3960, 8400, 18000,
                        28800, 41100, 66420, 144000, 314160,
                        686760, 1152000, 1728000, 2215980, 2880000,
                        3795420, 4042260, 4484520, 4836000, 5184000
                    ][level - 1] * 1000 * mult;
                }
            }

            var text = '';

            for (var i = 0; i < 3155; i++) {
                var cost = calculateAttributePrice(i);

                if (i < 632) {
                    var curve = getGoldCurve(i + 1);

                    var num = Math.trunc(curve / 10);
                    num = num * 12 / 100;
                    var griff = Math.min(10E6, num);

                    text += `<tr>
                        <td>${ i + 1 }</td>
                        <td>${ cost >= 999 ? formatAsSpacedNumber(cost, ' ') : roundShort(cost) }</td>
                        <td>${ curve / 100 >= 999 ? formatAsSpacedNumber(curve / 100, ' ') : roundShort(curve / 100) }</td>
                        <td>${ griff >= 999 ? formatAsSpacedNumber(griff, ' ') : roundShort(griff) }</td>
                        <td>${ num / 3 >= 999 ? formatAsSpacedNumber(num / 3, ' ') :roundShort(num / 3) }</td>
                    </tr>`;
                } else {
                    text += `<tr><td>${ i + 1 }</td><td>${ cost >= 999 ? formatAsSpacedNumber(cost, ' ') : roundShort(cost) }</td></tr>`;
                }
            }

            text += `<tr><td>3156 and above</td><td>${ formatAsSpacedNumber(10e6, ' ') }</td></tr>`;

            $('#attribute-prices').html(text);

            $('#priceat-attribute').on('change input', function () {
                if (validate($(this))) {
                    var value = Number($(this).val());
                    if (value < 1) value = 1;

                    var cost = calculateAttributePrice(value - 1);

                    $('#priceat-price').val(cost >= 10 ? formatAsSpacedNumber(cost, ' ') : roundShort(cost));
                }
            });

            function getValue (element, min, max) {
                return Math.max(min, Math.min(max, Number($(element).val())));
            }

            $('#misc-level, #misc-gate, #misc-torture').on('change input', function () {
                if (validate($('#misc-level'), $('#misc-gate'), $('#misc-torture'))) {
                    const level = getValue('#misc-level', 1, 700);
                    const gate = getValue('#misc-gate', 0, 15);
                    const torture = getValue('#misc-torture', 0, 15);

                    const MAXIMUM_SOULS_MULTIPLIER = 7.5;

                    let soulsMultiplier = (1 + 0.1 * torture) * (1 + 0.2 * Math.max(0, gate - 5));
                    let souls = Math.ceil((level < 542 ? (SoulsCurve[level] / MAXIMUM_SOULS_MULTIPLIER) : (464075 + (level - 525) * 8663)) * soulsMultiplier);

                    $('#misc-souls').val(formatValue(souls));
                }
            });

            $('#pricebetween-from, #pricebetween-to').on('change input', function () {
                if (validate($('#pricebetween-from'), $('#pricebetween-to'))) {
                    var from = Number($('#pricebetween-from').val());
                    var to = Number($('#pricebetween-to').val());

                    if (from > to) {
                        [from, to] = [to, from];
                    }

                    var cost = calculateTotalAttributePrice(to - 1) - calculateTotalAttributePrice(from - 1);

                    $('#pricebetween-price').val(cost >= 10 ? formatAsSpacedNumber(cost, ' ') : roundShort(cost));
                }
            });

            $('#xp-level, #xp-hydra, #xp-academy').on('change input', function () {
                if (validate($('#xp-level'), $('#xp-hydra'), $('#xp-academy'))) {
                    var level = Number($('#xp-level').val());
                    if (level < 1) level = 1;
                    else if (level > 699) level = 699;

                    var hydra = Number($('#xp-hydra').val());
                    if (hydra > 20) hydra = 20;
                    else if (hydra < 0) hydra = 0;

                    var academy = Number($('#xp-academy').val());
                    if (academy > 20) academy = 20;
                    else if (academy < 1) academy = 1;

                    var xp = getExperienceRequired(level);
                    var multiplier = 1.5 + 0.75 * (level - 1);
                    var base = xp / multiplier;
                    var daily = (1 + 0.25 * hydra) * base;
                    var arena = base / 10;
                    var hbase = (base / 30) / Math.max(1, Math.exp(30090.33 / 5000000 * (level - 99)));
                    var hourly = academy * hbase;
                    var capacity = academy * getAcademyMultiplier(academy) * hbase;
                    var time = capacity / hourly;

                    var wheel2 = Math.trunc(base / Math.max(1, Math.exp(30090.33 / 5000000 * (level - 99))));
                    var wheel1 = Math.trunc(wheel2 / 2);

                    var calendar1 = Math.ceil(xp / 15);
                    var calendar2 = Math.ceil(xp / 10);
                    var calendar3 = Math.ceil(xp / 5);
                    var habitat = 6 * hbase * multiplier;
                    var twister = Math.min(xp / 50, 30E6);

                    $('#xp-time').val(Math.trunc(time) + ' hours ' + Math.trunc(60 * (time % 1)) + ' minutes');
                    $('#xp-next').val(formatAsSpacedNumber(xp, ' '));
                    $('#xp-arena').val(formatAsSpacedNumber(arena, ' '));
                    $('#xp-daily').val(formatAsSpacedNumber(daily, ' '));
                    $('#xp-hourly').val(formatAsSpacedNumber(hourly, ' '));
                    $('#xp-capacity').val(formatAsSpacedNumber(capacity, ' '));

                    $('#xp-wheel1').val(formatAsSpacedNumber(wheel1, ' '));
                    $('#xp-wheel2').val(formatAsSpacedNumber(wheel2, ' '));

                    $('#xp-calendar1').val(formatAsSpacedNumber(calendar1, ' '));
                    $('#xp-calendar2').val(formatAsSpacedNumber(calendar2, ' '));
                    $('#xp-calendar3').val(formatAsSpacedNumber(calendar3, ' '));

                    $('#xp-habitat').val(formatAsSpacedNumber(habitat, ' '));
                    $('#xp-twister').val(formatAsSpacedNumber(twister, ' '));
                    $('#xp-dungeon').val(formatAsSpacedNumber(calendar3, ' '));
                }
            });

            $('#quest-level, #quest-xp, #quest-gold, #quest-tower, #quest-book, #quest-rxp, #quest-rgold').on('change input', function () {
                if (validate($('#quest-level'), $('#quest-xp'), $('#quest-gold'), $('#quest-tower'), $('#quest-book'), $('#quest-rxp'), $('#quest-rgold'))) {
                    var level = Number($('#quest-level').val());
                    if (level < 1) level = 1;
                    else if (level > 700) level = 700;

                    var gxp = Number($('#quest-xp').val());
                    if (gxp > 200) gxp = 200;
                    else if (gxp < 0) gxp = 0;

                    var ggold = Number($('#quest-gold').val());
                    if (ggold > 200) ggold = 200;
                    else if (ggold < 0) ggold = 0;

                    var book = Number($('#quest-book').val());
                    if (book > 100) book = 100;
                    else if (book < 0) book = 0;

                    var tower = Number($('#quest-tower').val());
                    if (tower > 100) tower = 100;
                    else if (tower < 0) tower = 0;

                    var rxp = Number($('#quest-rxp').val());
                    if (rxp > 10) rxp = 10;
                    else if (rxp < 0) rxp = 0;

                    var rgold = Number($('#quest-rgold').val());
                    if (rgold > 50) rgold = 50;
                    else if (rgold < 0) rgold = 0;

                    var basexp = getExperienceRequired(level) / (1.5 + 0.75 * (level - 1));
                    var basegold = getGoldCurve(level) * 12 / 1000;

                    var xpmin = (1 + rxp / 100) * (1 + gxp / 100 + book / 100) * basexp / 11 / Math.max(1, Math.exp(30090.33 / 5000000 * (level - 99)));
                    var xpmax = xpmin * 5;

                    var goldmin = Math.min(10000000, 1 * (1 + ggold / 100 + tower / 100) * basegold / 11) * (1 + rgold / 100);
                    var goldmax = Math.min(10000000, 5 * (1 + ggold / 100 + tower / 100) * basegold / 11) * (1 + rgold / 100);

                    $('#quest-goldmin').val(formatValue(goldmin));
                    $('#quest-goldmax').val(formatValue(goldmax));
                    $('#quest-xpmin').val(formatAsSpacedNumber(xpmin, ' '));
                    $('#quest-xpmax').val(formatAsSpacedNumber(xpmax, ' '));
                }
            });

            $('#gold-level, #gold-guild, #gold-tower, #gold-mine, #gold-pit, #gold-runes').on('change input', function () {
                if (validate($('#gold-level'), $('#gold-guild'), $('#gold-tower'), $('#gold-mine'), $('#gold-runes'), $('#gold-pit'))) {
                    var level = Number($('#gold-level').val());
                    if (level < 1) level = 1;
                    else if (level > 700) level = 700;

                    var guild = Number($('#gold-guild').val());
                    if (guild > 200) guild = 200;
                    else if (guild < 0) guild = 0;

                    var tower = Number($('#gold-tower').val());
                    if (tower > 100) tower = 100;
                    else if (tower < 0) tower = 0;

                    var mine = Number($('#gold-mine').val());
                    if (mine < 1) mine = 1;
                    else if (mine > 14) mine = 14;

                    var runes = Number($('#gold-runes').val());
                    if (runes < 0) runes = 0;
                    else if (runes > 5) runes = 5;

                    var pit = Number($('#gold-pit').val());
                    if (pit < 1) pit = 1;
                    else if (pit > 100) pit = 100;

                    var num = getGoldCurve(level) * 12 / 1000;

                    var guard = (num / 3) * (1 + guild / 100 + tower / 100);
                    var reward = num;
                    var dice = num / 3;

                    var scroll = Math.min(10E6, reward * 12.5 * (1 / 3));

                    var hourly = num * pit / 75;
                    let hourly_real = hourly * (1 + Math.max(0, pit - 15) / 100);
                    var guard = Math.min(10E6, guard);

                    var capacity = Math.min(37E6, Math.min(20E6, dice * Math.min(pit, 15) * 8 * (pit / 100)) + Math.max(0, pit - 15) * 200000);

                    var time = capacity / hourly;
                    let time_real = capacity / hourly_real;

                    var gem = num / 6;
                    gem = Math.min(10E6, gem * getMineMultiplier(mine));

                    var gem2 = getGoldCurve(level + 5) / 10;
                    gem2 = Math.min(10E6, gem2 * 2 * getMineMultiplier(mine) / 100);

                    var gem3 = getGoldCurve(level + 10) / 10;
                    gem3 = Math.min(10E6, gem3 * 2 * getMineMultiplier(mine) / 100);

                    var potion = (1 + Math.min(1, Math.max(0, (90 - level) / 10))) * getGoldCurve(Math.max(1, level - runes)) * 15 / 1000;

                    var pot10 = Math.min(5E6, potion / 4);
                    var pot15 = Math.min(5E6, potion / 2);
                    var pot25 = Math.min(5E6, potion / 1);

                    var pothp = Math.min(5E6, potion / 3);
                    var pothp_gold = Math.min(10E6, potion / 1);

                    var reroll = reward * 5 / 8;
                    var potwitch = reward * 5 / 6;

                    var hourglass1 = Math.min(375000, potion / 6);
                    if (hourglass1 > 37500) hourglass1 = 375000;
                    var hourglass10 = Math.min(3750000, 10 * hourglass1);

                    var goldbar3 = dice * 25;
                    var goldbar1 = 3 * goldbar3 / 10;

                    var towerboss = (9 * getGoldCurve(level + 2 ) / 100);
                    var twisterboss = (2 * getGoldCurve(level) / 100);

                    var arenagold = level > 95 ? Math.trunc(twisterboss / getArenaMultiplier(level)) : level;

                    reward = Math.min(10E6, reward);

                    $('#gold-bar').val(formatValue(goldbar1));
                    $('#gold-bar3').val(formatValue(goldbar3));
                    $('#gold-towerboss').val(formatValue(towerboss));
                    $('#gold-twisterboss').val(formatValue(twisterboss));

                    $('#gold-pot10').val(formatValue(pot10));
                    $('#gold-pot15').val(formatValue(pot15));
                    $('#gold-pot25').val(formatValue(pot25));
                    $('#gold-pothp').val(formatValue(pothp));
                    $('#gold-pothp-gold').val(formatValue(pothp_gold));

                    $('#gold-arena').val(formatValue(arenagold));

                    $('#gold-scroll').val(formatValue(scroll));
                    $('#gold-witchpot').val(formatValue(potwitch));

                    $('#gold-hourglass1').val(formatValue(hourglass1));
                    $('#gold-hourglass10').val(formatValue(hourglass10));

                    $('#gold-guard').val(formatValue(guard));
                    $('#gold-reward').val(formatValue(reward));
                    $('#gold-reroll').val(formatValue(reroll));

                    $('#gold-dice').val(formatValue(dice));
                    $('#gold-dice2').val(formatValue(dice * 5));
                    $('#gold-dice3').val(formatValue(dice * 25));

                    $('#gold-gem').val(formatValue(gem));
                    $('#gold-gem2').val(formatValue(gem2));
                    $('#gold-gem3').val(formatValue(gem3));

                    $('#gold-hourly').val(formatValue(hourly));
                    $('#gold-hourly-real').val(formatValue(hourly_real));
                    $('#gold-time').val(formatTime(time));
                    $('#gold-time-real').val(formatTime(time_real));
                    $('#gold-capacity').val(formatAsSpacedNumber(capacity, ' '));
                }
            });

            $('#copy-table').click(() => {
                var range = document.createRange();
                range.selectNode($('#data-table').get(0));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
            });

            $('#copy-table-col').click(() => {
                $('#data-table').find('td').each(function (i, o) {
                    $(o).html($(o).html().replace('.', ','));
                });

                var range = document.createRange();
                range.selectNode($('#data-table').get(0));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();

                $('#data-table').find('td').each(function (i, o) {
                    $(o).html($(o).html().replace(',', '.'));
                });
            });
        </script>
    </body>
</html>
