<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Attribute Costs</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/html2canvas.js"></script>

        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/components/state.min.js"></script>

        <script src="js/util.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item">SFTools</div>
            <div class="right menu">
                <a class="item" href="index.html"><i class="small reply icon"></i><span class="css-small">Go back</span></a>
            </div>
        </div>

        <div class="ui main container">
            <div class="ui grid">
                <div class="sixteen wide column">
                    <div class="ui segment">
                        <h3 class="ui header">Calculate price at</h3>
                        <div class="ui small form">
                            <div class="two fields">
                                <div class="field">
                                    <label>Attribute</label>
                                    <input type="text" id="priceat-attribute" val="0">
                                </div>
                                <div class="field">
                                    <label>Cost</label>
                                    <input type="text" disabled id="priceat-price">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui segment">
                        <h3 class="ui header">Calculate price between</h3>
                        <div class="ui small form">
                            <div class="three fields">
                                <div class="field">
                                    <label>From</label>
                                    <input type="text" id="pricebetween-from">
                                </div>
                                <div class="field">
                                    <label>To</label>
                                    <input type="text" id="pricebetween-to">
                                </div>
                                <div class="field">
                                    <label>Cost</label>
                                    <input type="text" disabled id="pricebetween-price">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui segment">
                        <h3 class="ui header">Calculate gold rewards</h3>
                        <div class="ui small form">
                            <div class="five fields">
                                <div class="field">
                                    <label>Level</label>
                                    <input type="text" id="gold-level">
                                </div>
                                <div class="field">
                                    <label>Guild bonus %</label>
                                    <input type="text" id="gold-guild">
                                </div>
                                <div class="field">
                                    <label>Tower bonus %</label>
                                    <input type="text" id="gold-tower">
                                </div>
                                <div class="field">
                                    <label>Gem Mine</label>
                                    <input type="text" id="gold-mine">
                                </div>
                                <div class="field">
                                    <label>Gold Pit</label>
                                    <input type="text" id="gold-pit">
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field">
                                    <label>Environmental reward</label>
                                    <input type="text" disabled id="gold-reward">
                                </div>
                                <div class="field">
                                    <label>Hourly guard duty</label>
                                    <input type="text" disabled id="gold-guard">
                                </div>
                                <div class="field">
                                    <label>Dice game (3 of kind)</label>
                                    <input type="text" disabled id="gold-dice">
                                </div>
                                <div class="field">
                                    <label>Small gem</label>
                                    <input type="text" disabled id="gold-gem">
                                </div>
                                <div class="field">
                                    <label>Hourly gold pit</label>
                                    <input type="text" disabled id="gold-hourly">
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field"></div>
                                <div class="field"></div>
                                <div class="field">
                                    <label>Dice game (4 of kind)</label>
                                    <input type="text" disabled id="gold-dice2">
                                </div>
                                <div class="field">
                                    <label>Medium gem</label>
                                    <input type="text" disabled id="gold-gem2">
                                </div>
                                <div class="field">
                                    <label>Gold pit time</label>
                                    <input type="text" disabled id="gold-time">
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field"></div>
                                <div class="field"></div>
                                <div class="field">
                                    <label>Dice game (5 of kind)</label>
                                    <input type="text" disabled id="gold-dice3">
                                </div>
                                <div class="field">
                                    <label>large gem</label>
                                    <input type="text" disabled id="gold-gem3">
                                </div>
                                <div class="field">
                                    <label>Gold pit capacity</label>
                                    <input type="text" disabled id="gold-capacity">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sixteen wide column">
                    <button class="ui right floated button small" id="copy-table-col" style="margin-bottom: 0.5em; margin-top: -1em; margin-left: 1em;">Copy table (comma)</button>
                    <button class="ui right floated button small" id="copy-table" style="margin-bottom: 0.5em; margin-top: -1em;">Copy table</button>
                    <table class="ui celled structured table table-group" id="data-table">
                        <thead>
                            <tr>
                                <td width="150">Attribute / Level</td>
                                <td width="150">Attribute Price</td>
                                <td width="150">Gold Curve</td>
                                <td width="150">Griffin</td>
                                <td width="150">Guard Duty / Dice (3)</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="border-bottom-thick"></td>
                            </tr>
                        </thead>
                        <tbody id="attribute-prices" class="opaque-rows" style="text-align: center;">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            function validate (... elements) {
                return elements.reduce((errors, element) => {
                    if (isNaN($(element).val()) || $(element).val() < 0) {
                        $(element).parent('.field').addClass('error');
                        return errors + 1;
                    } else {
                        $(element).parent('.field').removeClass('error');
                        return errors;
                    }
                }, 0) == 0;
            }

            function roundShort(value) {
                return Math.trunc(value * 100) / 100;
            }

            function getMineMultiplier(m) {
                if (m <= 1) {
                    return 1;
                } else if (m >= 14) {
                    return 24;
                } else switch (m) {
                    case 2: return 2;
                    case 3: return 3;
                    case 4: return 4;
                    case 5: return 6;
                    case 6: return 8;
                    case 7: return 10;
                    case 8: return 12;
                    case 9: return 14;
                    case 10: return 16;
                    case 11: return 18;
                    case 12: return 20;
                    case 13: return 22;
                }
            }

            var text = '';

            for (var i = 0; i < 3155; i++) {
                var cost = calculateAttributePrice(i);

                if (i < 632) {
                    var curve = getGoldCurve(i + 1);

                    var num = Math.trunc(curve / 10);
                    if (num > 9999) num = Math.trunc(num / 100) * 100;
                    num = num * 12 / 100;

                    text += `<tr>
                        <td>${ i + 1 }</td>
                        <td>${ cost >= 10 ? formatAsSpacedNumber(cost) : roundShort(cost) }</td>
                        <td>${ curve / 100 >= 10 ? formatAsSpacedNumber(curve / 100) : roundShort(curve / 100) }</td>
                        <td>${ num >= 10 ? formatAsSpacedNumber(num) : roundShort(num) }</td>
                        <td>${ num / 3 >= 10 ? formatAsSpacedNumber(num / 3) :roundShort(num / 3) }</td>
                    </tr>`;
                } else {
                    text += `<tr><td>${ i + 1 }</td><td>${ cost >= 10 ? formatAsSpacedNumber(cost) : roundShort(cost) }</td></tr>`;
                }
            }

            text += `<tr><td>3156 and above</td><td>${ formatAsSpacedNumber(10e6) }</td></tr>`;

            $('#attribute-prices').html(text);

            $('#priceat-attribute').on('change input', function () {
                if (validate($(this))) {
                    var value = Number($(this).val());
                    if (value < 1) value = 1;

                    var cost = calculateAttributePrice(value - 1);

                    $('#priceat-price').val(cost >= 10 ? formatAsSpacedNumber(cost, ' ') : roundShort(cost));
                }
            });

            $('#pricebetween-from, #pricebetween-to').on('change input', function () {
                if (validate($('#pricebetween-from'), $('#pricebetween-to'))) {
                    var from = Number($('#pricebetween-from').val());
                    var to = Number($('#pricebetween-to').val());

                    if (from > to) {
                        [from, to] = [to, from];
                    }

                    var cost = calculateTotalAttributePrice(to - 1) - calculateTotalAttributePrice(from - 1);

                    $('#pricebetween-price').val(cost >= 10 ? formatAsSpacedNumber(cost, ' ') : roundShort(cost));
                }
            });

            $('#gold-level, #gold-guild, #gold-tower, #gold-mine, #gold-pit').on('change input', function () {
                if (validate($('#gold-level'), $('#gold-guild'), $('#gold-tower'), $('#gold-mine'))) {
                    var level = Number($('#gold-level').val());
                    if (level < 1) level = 1;
                    else if (level > 632) level = 632;

                    var guild = Number($('#gold-guild').val());
                    if (guild > 200) guild = 200;

                    var tower = Number($('#gold-tower').val());
                    if (tower > 100) tower = 100;

                    var mine = Number($('#gold-mine').val());
                    if (mine < 1) mine = 1;
                    else if (mine > 14) mine = 14;

                    var pit = Number($('#gold-pit').val());
                    if (pit < 1) pit = 1;
                    else if (pit > 100) pit = 100;

                    var num = Math.trunc(getGoldCurve(level) / 10);
                    if (num > 9999) {
                        num = Math.trunc(num / 100) * 100;
                    }

                    num = num * 12 / 100;

                    var guard = (num / 3) * (1 + guild / 100 + tower / 100);
                    var reward = num;
                    var dice = num / 3;

                    var hourly = Math.min(10E6, guard * pit / 100);
                    var guard = Math.min(10E6, guard);

                    var capacity = Math.min(10E6, dice * Math.min(pit, 15) * 8 * (pit / 100)) + Math.max(0, pit - 15) * 100000;

                    var time = capacity / hourly;

                    var gem = num / 6;
                    gem = Math.min(10E6, gem * getMineMultiplier(mine));

                    var gem2 = Math.trunc(getGoldCurve(level + 5) / 10);
                    if (gem2 > 9999) gem2 = Math.trunc(gem2 / 100) * 100;
                    gem2 = Math.min(10E6, gem2 * 2 * getMineMultiplier(mine) / 100);

                    var gem3 = Math.trunc(getGoldCurve(level + 10) / 10);
                    if (gem3 > 9999) gem3 = Math.trunc(gem3 / 100) * 100;
                    gem3 = Math.min(10E6, gem3 * 2 * getMineMultiplier(mine) / 100);

                    $('#gold-guard').val(guard >= 10 ? formatAsSpacedNumber(guard, ' ') : roundShort(guard));
                    $('#gold-reward').val(reward >= 10 ? formatAsSpacedNumber(reward, ' ') : roundShort(reward));

                    $('#gold-dice').val(dice >= 10 ? formatAsSpacedNumber(dice, ' ') : roundShort(dice));
                    $('#gold-dice2').val(dice * 5 >= 10 ? formatAsSpacedNumber(dice * 5, ' ') : roundShort(dice * 5));
                    $('#gold-dice3').val(dice * 25 >= 10 ? formatAsSpacedNumber(dice * 25, ' ') : roundShort(dice * 25));

                    $('#gold-gem').val(gem >= 10 ? formatAsSpacedNumber(gem, ' ') : roundShort(gem));
                    $('#gold-gem2').val(gem2 >= 10 ? formatAsSpacedNumber(gem2, ' ') : roundShort(gem2));
                    $('#gold-gem3').val(gem3 >= 10 ? formatAsSpacedNumber(gem3, ' ') : roundShort(gem3));

                    $('#gold-hourly').val(hourly >= 10 ? formatAsSpacedNumber(hourly, ' ') : roundShort(hourly));
                    $('#gold-capacity').val(formatAsSpacedNumber(capacity, ' '));
                    $('#gold-time').val(Math.trunc(time) + ' hours ' + Math.trunc(60 * (time % 1)) + ' minutes');
                }
            });

            $('#copy-table').click(() => {
                var range = document.createRange();
                range.selectNode($('#data-table').get(0));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
            });

            $('#copy-table-col').click(() => {
                $('#data-table').find('td').each(function (i, o) {
                    $(o).html($(o).html().replace('.', ','));
                });

                var range = document.createRange();
                range.selectNode($('#data-table').get(0));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();

                $('#data-table').find('td').each(function (i, o) {
                    $(o).html($(o).html().replace(',', '.'));
                });
            });
        </script>
    </body>
</html>
